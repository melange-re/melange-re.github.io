<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Json (melange.Js.Json)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="canonical" href="https://melange.re/v4.0.0/api/ml/melange/Js/Json/index.html" /></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">melange</a> &#x00BB; <a href="../index.html">Js</a> &#x00BB; Json</nav><header class="odoc-preamble"><h1>Module <code><span>Js.Json</span></code></h1><p>Utility functions to manipulate JSON values</p><p>Efficient JSON encoding using JavaScript API @see &lt;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON&gt; MDN</p></header><nav class="odoc-toc"><ul><li><a href="#types">Types</a></li><li><a href="#accessor">Accessor</a></li><li><a href="#construtors">Construtors</a></li><li><a href="#string-conversion">String conversion</a></li></ul></nav><div class="odoc-content"><h3 id="types"><a href="#types" class="anchor"></a>Types</h3><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The JSON data structure</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-kind"><a href="#type-kind" class="anchor"></a><code><span><span class="keyword">type</span> <span>_ kind</span></span><span> = </span></code><ol><li id="type-kind.String" class="def variant constructor anchored"><a href="#type-kind.String" class="anchor"></a><code><span>| </span><span><span class="constructor">String</span> : <span>string <a href="#type-kind">kind</a></span></span></code></li><li id="type-kind.Number" class="def variant constructor anchored"><a href="#type-kind.Number" class="anchor"></a><code><span>| </span><span><span class="constructor">Number</span> : <span>float <a href="#type-kind">kind</a></span></span></code></li><li id="type-kind.Object" class="def variant constructor anchored"><a href="#type-kind.Object" class="anchor"></a><code><span>| </span><span><span class="constructor">Object</span> : <span><span><a href="#type-t">t</a> <a href="../index.html#type-dict">Js.dict</a></span> <a href="#type-kind">kind</a></span></span></code></li><li id="type-kind.Array" class="def variant constructor anchored"><a href="#type-kind.Array" class="anchor"></a><code><span>| </span><span><span class="constructor">Array</span> : <span><span><a href="#type-t">t</a> array</span> <a href="#type-kind">kind</a></span></span></code></li><li id="type-kind.Boolean" class="def variant constructor anchored"><a href="#type-kind.Boolean" class="anchor"></a><code><span>| </span><span><span class="constructor">Boolean</span> : <span>bool <a href="#type-kind">kind</a></span></span></code></li><li id="type-kind.Null" class="def variant constructor anchored"><a href="#type-kind.Null" class="anchor"></a><code><span>| </span><span><span class="constructor">Null</span> : <span><span><a href="#type-t">t</a> <a href="../index.html#type-null">Js.null</a></span> <a href="#type-kind">kind</a></span></span></code></li></ol></div><div class="spec-doc"><p>Underlying type of a JSON value</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-tagged_t"><a href="#type-tagged_t" class="anchor"></a><code><span><span class="keyword">type</span> tagged_t</span><span> = </span></code><ol><li id="type-tagged_t.JSONFalse" class="def variant constructor anchored"><a href="#type-tagged_t.JSONFalse" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONFalse</span></span></code></li><li id="type-tagged_t.JSONTrue" class="def variant constructor anchored"><a href="#type-tagged_t.JSONTrue" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONTrue</span></span></code></li><li id="type-tagged_t.JSONNull" class="def variant constructor anchored"><a href="#type-tagged_t.JSONNull" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONNull</span></span></code></li><li id="type-tagged_t.JSONString" class="def variant constructor anchored"><a href="#type-tagged_t.JSONString" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONString</span> <span class="keyword">of</span> string</span></code></li><li id="type-tagged_t.JSONNumber" class="def variant constructor anchored"><a href="#type-tagged_t.JSONNumber" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONNumber</span> <span class="keyword">of</span> float</span></code></li><li id="type-tagged_t.JSONObject" class="def variant constructor anchored"><a href="#type-tagged_t.JSONObject" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONObject</span> <span class="keyword">of</span> <span><a href="#type-t">t</a> <a href="../index.html#type-dict">Js.dict</a></span></span></code></li><li id="type-tagged_t.JSONArray" class="def variant constructor anchored"><a href="#type-tagged_t.JSONArray" class="anchor"></a><code><span>| </span><span><span class="constructor">JSONArray</span> <span class="keyword">of</span> <span><a href="#type-t">t</a> array</span></span></code></li></ol></div></div><h3 id="accessor"><a href="#accessor" class="anchor"></a>Accessor</h3><div class="odoc-spec"><div class="spec value anchored" id="val-classify"><a href="#val-classify" class="anchor"></a><code><span><span class="keyword">val</span> classify : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-tagged_t">tagged_t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-test"><a href="#val-test" class="anchor"></a><code><span><span class="keyword">val</span> test : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-kind">kind</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>test v kind</code> returns true if <code>v</code> is of <code>kind</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decodeString"><a href="#val-decodeString" class="anchor"></a><code><span><span class="keyword">val</span> decodeString : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p><code>decodeString json</code> returns <code>Some s</code> if <code>json</code> is a string, <code>None</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decodeNumber"><a href="#val-decodeNumber" class="anchor"></a><code><span><span class="keyword">val</span> decodeNumber : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>float option</span></span></code></div><div class="spec-doc"><p><code>decodeNumber json</code> returns <code>Some n</code> if <code>json</code> is a number, <code>None</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decodeObject"><a href="#val-decodeObject" class="anchor"></a><code><span><span class="keyword">val</span> decodeObject : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-t">t</a> <a href="../index.html#type-dict">Js.dict</a></span> option</span></span></code></div><div class="spec-doc"><p><code>decodeObject json</code> returns <code>Some o</code> if <code>json</code> is an object, <code>None</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decodeArray"><a href="#val-decodeArray" class="anchor"></a><code><span><span class="keyword">val</span> decodeArray : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-t">t</a> array</span> option</span></span></code></div><div class="spec-doc"><p><code>decodeArray json</code> returns <code>Some a</code> if <code>json</code> is an array, <code>None</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decodeBoolean"><a href="#val-decodeBoolean" class="anchor"></a><code><span><span class="keyword">val</span> decodeBoolean : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool option</span></span></code></div><div class="spec-doc"><p><code>decodeBoolean json</code> returns <code>Some b</code> if <code>json</code> is a boolean, <code>None</code> otherwise</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-decodeNull"><a href="#val-decodeNull" class="anchor"></a><code><span><span class="keyword">val</span> decodeNull : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="../index.html#type-null">Js.null</a></span> option</span></span></code></div><div class="spec-doc"><p><code>decodeNull json</code> returns <code>Some null</code> if <code>json</code> is a null, <code>None</code> otherwise</p></div></div><h3 id="construtors"><a href="#construtors" class="anchor"></a>Construtors</h3><p>Those functions allows the construction of an arbitrary complex JSON values.</p><div class="odoc-spec"><div class="spec value external anchored" id="val-null"><a href="#val-null" class="anchor"></a><code><span><span class="keyword">val</span> null : <a href="#type-t">t</a></span></code></div></div><p><code>null</code> is the singleton null JSON value</p><div class="odoc-spec"><div class="spec value external anchored" id="val-string"><a href="#val-string" class="anchor"></a><code><span><span class="keyword">val</span> string : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>string s</code> makes a JSON string of the <code>string</code> <code>s</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-number"><a href="#val-number" class="anchor"></a><code><span><span class="keyword">val</span> number : <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>number n</code> makes a JSON number of the <code>float</code> <code>n</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-boolean"><a href="#val-boolean" class="anchor"></a><code><span><span class="keyword">val</span> boolean : <span>bool <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>boolean b</code> makes a JSON boolean of the <code>bool</code> <code>b</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-object_"><a href="#val-object_" class="anchor"></a><code><span><span class="keyword">val</span> object_ : <span><span><a href="#type-t">t</a> <a href="../index.html#type-dict">Js.dict</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>object_ dict</code> makes a JSON object of the <code>Js.dict</code> <code>dict</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-array"><a href="#val-array" class="anchor"></a><code><span><span class="keyword">val</span> array : <span><span><a href="#type-t">t</a> array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>array a</code> makes a JSON array of the <code>Js.Json.t array</code> <code>a</code></p></div></div><p>The functions below are specialized for specific array type which happened to be already JSON object in the Melange runtime. Therefore they are more efficient (constant time rather than linear conversion).</p><div class="odoc-spec"><div class="spec value external anchored" id="val-stringArray"><a href="#val-stringArray" class="anchor"></a><code><span><span class="keyword">val</span> stringArray : <span><span>string array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>stringArray a</code> makes a JSON array of the <code>string array</code> <code>a</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-numberArray"><a href="#val-numberArray" class="anchor"></a><code><span><span class="keyword">val</span> numberArray : <span><span>float array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>numberArray a</code> makes a JSON array of the <code>float array</code> <code>a</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-booleanArray"><a href="#val-booleanArray" class="anchor"></a><code><span><span class="keyword">val</span> booleanArray : <span><span>bool array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>booleanArray</code> makes a JSON array of the <code>bool array</code> <code>a</code></p></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-objectArray"><a href="#val-objectArray" class="anchor"></a><code><span><span class="keyword">val</span> objectArray : <span><span><span><a href="#type-t">t</a> <a href="../index.html#type-dict">Js.dict</a></span> array</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>objectArray a</code> makes a JSON array of the <code>JsDict.t array</code> <code>a</code></p></div></div><h3 id="string-conversion"><a href="#string-conversion" class="anchor"></a>String conversion</h3><div class="odoc-spec"><div class="spec value external anchored" id="val-parseExn"><a href="#val-parseExn" class="anchor"></a><code><span><span class="keyword">val</span> parseExn : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>parseExn s</code> parses the string <code>s</code> into a JSON data structure</p><p><b>Returns</b> a JSON data structure</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>SyntaxError</code> <p>if given string is not a valid JSON. Note <code>SyntaxError</code> is a JavaScript exception.</p><pre class="language-ocaml"><code>(* parse a simple JSON string *)

let json =
  try
    Js.Json.parseExn {| &quot;foo&quot; |}
  with
  | _ -&gt; failwith &quot;Error parsing JSON string&quot;
in
match Js.Json.classify json with
| Js.Json.JSONString value -&gt; Js.log value
| _ -&gt; failwith &quot;Expected a string&quot;</code></pre><pre class="language-ocaml"><code>(* parse a complex JSON string *)

let getIds s =
  let json =
    try
      Js.Json.parseExn s
    with
    | _ -&gt; failwith &quot;Error parsing JSON string&quot;
  in
  match Js.Json.classify json with
  | Js.Json.JSONObject value -&gt;
    (* In this branch, compiler infer value : Js.Json.t Js.dict *)
    begin match Js.Dict.get value &quot;ids&quot; with
    | Some ids -&gt;
      begin match Js.Json.classify ids with
      | Js.Json.JSONArray ids -&gt;
        (* In this branch compiler infer ids : Js.Json.t array *)
        ids
      | _ -&gt; failwith &quot;Expected an array&quot;
      end
    | None -&gt; failwith &quot;Expected an `ids` property&quot;
    end
  | _ -&gt; failwith &quot;Expected an object&quot;

  (* prints `1, 2, 3` *)
  let _ =
    Js.log (getIds {| { &quot;ids&quot; : [1, 2, 3] } |})</code></pre></li></ul><ul class="at-tags"><li class="see"><span class="at-tag">see</span> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse" class="value">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse</a> <p>MDN</p></li></ul></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-stringify"><a href="#val-stringify" class="anchor"></a><code><span><span class="keyword">val</span> stringify : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>stringify json</code> formats the JSON data structure as a string</p><p><b>Returns</b> the string representation of a given JSON data structure</p><pre class="language-ocaml"><code>(* Creates and stringifies a simple JS object *)

let dict = Js.Dict.empty () in
Js.Dict.set dict &quot;name&quot; (Js.Json.string &quot;John Doe&quot;);
Js.Dict.set dict &quot;age&quot; (Js.Json.number 30.0);
Js.Dict.set dict &quot;likes&quot;
  (Js.Json.stringArray [|&quot;bucklescript&quot;;&quot;ocaml&quot;;&quot;js&quot;|]);

Js.log (Js.Json.stringify (Js.Json.object_ dict))</code></pre><ul class="at-tags"><li class="see"><span class="at-tag">see</span> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify" class="value">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify</a> <p>MDN</p></li></ul></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-stringifyWithSpace"><a href="#val-stringifyWithSpace" class="anchor"></a><code><span><span class="keyword">val</span> stringifyWithSpace : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>stringify json</code> formats the JSON data structure as a string</p><p><b>Returns</b> the string representation of a given JSON data structure</p><pre class="language-ocaml"><code>(* Creates and stringifies a simple JS object with spacing *)

let dict = Js.Dict.empty () in
Js.Dict.set dict &quot;name&quot; (Js.Json.string &quot;John Doe&quot;);
Js.Dict.set dict &quot;age&quot; (Js.Json.number 30.0);
Js.Dict.set dict &quot;likes&quot;
  (Js.Json.stringArray [|&quot;bucklescript&quot;;&quot;ocaml&quot;;&quot;js&quot;|]);

  Js.log (Js.Json.stringifyWithSpace (Js.Json.object_ dict) 2)</code></pre><ul class="at-tags"><li class="see"><span class="at-tag">see</span> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify" class="value">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify</a> <p>MDN</p></li></ul></div></div><div class="odoc-spec"><div class="spec value external anchored" id="val-stringifyAny"><a href="#val-stringifyAny" class="anchor"></a><code><span><span class="keyword">val</span> stringifyAny : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span>string option</span></span></code></div><div class="spec-doc"><p><code>stringifyAny value</code> formats any <code>value</code> into a JSON string</p><pre class="language-ocaml"><code>(* prints ``&quot;foo&quot;, &quot;bar&quot;`` *)
Js.log (Js.Json.stringifyAny [| &quot;foo&quot;; &quot;bar&quot; |])</code></pre><ul class="at-tags"><li class="see"><span class="at-tag">see</span> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify" class="value">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify</a> <p>MDN</p></li></ul></div></div><p>Best-effort serialization, it tries to seralize as many objects as possible and deserialize it back</p><div class="odoc-spec"><div class="spec value anchored" id="val-deserializeUnsafe"><a href="#val-deserializeUnsafe" class="anchor"></a><code><span><span class="keyword">val</span> deserializeUnsafe : <span>string <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>It is unsafe in two aspects</p><ul><li>It may throw during parsing</li><li>when you cast it to a specific type, it may have a type mismatch</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-serializeExn"><a href="#val-serializeExn" class="anchor"></a><code><span><span class="keyword">val</span> serializeExn : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>It will raise in such situations:</p><ul><li>The object can not be serlialized to a JSON</li><li>There are cycles</li><li>Some JS engines can not stringify deeply nested json objects</li></ul></div></div></div></body></html>
