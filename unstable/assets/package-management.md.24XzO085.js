import{_ as a,c as e,o as s,V as i}from"./chunks/framework.BCxdY_ip.js";const m=JSON.parse('{"title":"Package management","description":"","frontmatter":{},"headers":[],"relativePath":"package-management.md","filePath":"package-management.md"}'),n={name:"package-management.md"},t=i(`<h1 id="package-management" tabindex="-1">Package management <a class="header-anchor" href="#package-management" aria-label="Permalink to &quot;Package management&quot;">​</a></h1><p>Melange can consume packages from both the <a href="https://www.npmjs.com/" target="_blank" rel="noreferrer">npm registry</a> and the <a href="https://opam.ocaml.org/packages/" target="_blank" rel="noreferrer">opam repository</a>.</p><ul><li>For Melange libraries and bindings (compile-time dependencies), use one of the package management alternatives described in <a href="./getting-started.html">Getting started</a>. The rest of this guide assumes you&#39;re using opam.</li><li>For JavaScript packages required by Melange bindings (runtime dependencies), use <a href="https://docs.npmjs.com/cli/" target="_blank" rel="noreferrer">npm</a> (or <a href="https://npmtrends.com/@microsoft/rush-vs-bolt-vs-pnpm-vs-rush-vs-yarn" target="_blank" rel="noreferrer">any of its alternatives</a>).</li></ul><p>Integrating with opam provides Melange projects with a native toolchain. Opam has been designed for the OCaml language, and it enables Melange projects to have first-class access to <a href="https://ocaml.org/docs/metaprogramming" target="_blank" rel="noreferrer">PPXs</a>, compiler libraries, editor integration software and other tools.</p><p>In the following sections, we explain in detail how to use opam to define the dependencies of our application, as well as how to publish packages in the public opam repository. However, this documentation is not exhaustive and only covers what we believe are the most important parts for Melange developers. If you want to learn more about opam, please refer to the <a href="https://opam.ocaml.org/doc/Manual.html" target="_blank" rel="noreferrer">opam manual</a> and <a href="https://opam.ocaml.org/doc/FAQ.html" target="_blank" rel="noreferrer">FAQ page</a>.</p><h2 id="opam-for-melange-developers" tabindex="-1">opam for Melange developers <a class="header-anchor" href="#opam-for-melange-developers" aria-label="Permalink to &quot;opam for Melange developers&quot;">​</a></h2><p>Before diving into specifics about using opam, there are the two relevant differences between opam and npm that are worth mentioning.</p><p><strong>1. One version of each package</strong></p><p>At any given time, any opam switch can only install <em>at most</em> a single version of a package. This is known as a flat dependency graph, and some package managers (like <a href="https://bower.io/" target="_blank" rel="noreferrer">Bower</a>) follow a similar approach.</p><p>A flat dependency graph means that, for example, it is impossible to have two versions of <a href="https://github.com/reasonml/reason-react/" target="_blank" rel="noreferrer"><code>reason-react</code></a> installed in the same project. This avoids some headaches when one inadvertently installs two versions of a dependency. Also, and specifically for Melange, it helps keep the resulting JavaScript bundle lean and reduce page load for browser-based applications.</p><p>On the other hand, upgrading your project dependencies to more recent versions might become tricky. Due to the restriction where only one version of a package can be installed, there is a higher chance for conflicts between the constraints of the transitive dependencies. If opam cannot find a solution, these conflicts need to be solved manually. This generally involves updating the conflicting dependency to make it compatible with a newer version of Melange or a transient dependency.</p><p><strong>2. A source-based package manager for a compiled language</strong></p><p>opam distributes just the source code of the packages and leaves the compilation step to a build phase that runs when consuming them, after they have been fetched. As a package manager for a compiled language like OCaml, opam has first-class support for this build step. Every package must tell opam how it should be built, and the way to do this is by using the <a href="https://opam.ocaml.org/doc/Manual.html#opamfield-build" target="_blank" rel="noreferrer"><code>build</code> field</a> in the package <code>.opam</code> file. This is different than how npm is used: most published packages in the npm registry don’t rely on a build step.</p><p>As Melange relies on OCaml packages for the compilation step (either PPXs, linters, instrumentation, or any other build-time package), it’s integrated with the native toolchain that OCaml programmers are familiar with, which relieves library authors of the burden of creating and distributing pre-built versions of their packages.</p><hr><p>Let’s go now through the most common actions with opam when working on Melange projects. The following guide is based on the amazing <a href="http://ocamlverse.net/content/opam_npm.html" target="_blank" rel="noreferrer">opam for npm/yarn users</a> guide by Louis (<a href="https://github.com/Khady" target="_blank" rel="noreferrer">@khady</a>).</p><h3 id="initial-configuration" tabindex="-1">Initial configuration <a class="header-anchor" href="#initial-configuration" aria-label="Permalink to &quot;Initial configuration&quot;">​</a></h3><p>The first thing to do is to install opam. There is an <a href="https://opam.ocaml.org/doc/Install.html" target="_blank" rel="noreferrer">official documentation page</a> on installation. Most of the time, we can get it from your package manager. Otherwise, binaries are provided for every platform.</p><p>There is a necessary first step before using opam:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init -a</span></span></code></pre></div><p>Here is what the documentation of the <code>opam init</code> command says:</p><blockquote><p>The init command initialises a local &quot;opam root&quot; (by default, <code>~/.opam/</code>) that holds opam’s data and packages. This is a necessary step for normal operation of opam. The initial software repositories are fetched, and an initial &#39;switch&#39; can also be installed, according to the configuration and options. These can be afterwards configured using opam switch and opam repository.</p></blockquote><blockquote><p>Additionally, this command allows to customise some aspects of opam’s shell integration, when run initially (avoiding the interactive dialog), but also at any later time.</p></blockquote><p>The interesting parts are:</p><ul><li>The opam root is at <code>~/.opam</code></li><li>opam uses shell integration to make our life easier</li><li>opam uses the concept of a <em>switch</em></li></ul><p>A switch is the equivalent of the <code>node_modules</code> folder in npm’s world. It contains all the packages that are installed. There are local switches and global switches, in the same way we can have a <code>node_modules</code> folder local to our project or install global dependencies using <code>yarn global</code> or <code>npm install -g</code>. Global switches can be handy sometimes, but to avoid confusion, the recommendation is to avoid them.</p><p>The default settings can be changed if the <code>-a</code> option is omitted while calling <code>opam init</code>.</p><h3 id="minimal-app-opam-file" tabindex="-1">Minimal <code>app.opam</code> file <a class="header-anchor" href="#minimal-app-opam-file" aria-label="Permalink to &quot;Minimal \`app.opam\` file&quot;">​</a></h3><p>The equivalent to <code>package.json</code> is an <code>app.opam</code> file, where <code>app</code> is the name of the package. It is possible to have multiple opam files in the same directory or project.</p><p>There is no opam command to manipulate the opam file. A command similar to <code>npm init</code> or <code>yarn add</code> does not exist in opam, so the updates in <code>.opam</code> files have to be done by hand.</p><p>A minimal <code>.opam</code> file looks like this:</p><div class="language-opam vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">opam</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">opam-version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2.0&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;my-app&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">authors</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Louis&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">homepage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;https://github.com/khady/example&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">maintainer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ex@ample.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dev-repo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;git+ssh://git@github.com:khady/example.git&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">bug-reports</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;https://github.com/khady/example/issues&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0.1&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">build</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dune&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;subst&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] {</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pinned</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dune&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;build&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-p&quot;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-j&quot;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">depends</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;dune&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p><code>build:</code> tells opam that <code>dune</code> is needed only to build the project.</p><h3 id="installing-packages" tabindex="-1">Installing packages <a class="header-anchor" href="#installing-packages" aria-label="Permalink to &quot;Installing packages&quot;">​</a></h3><p>The first thing we need is a local switch in the current project. To verify if a switch exists already, we can look for a <code>_opam</code> directory at the root of the project or use the <code>opam switch</code> command to identify if a switch already exists in the project folder.</p><p>If it does not exist, we can create it with:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> switch create . </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.0 --deps-only</span></span></code></pre></div><p>If it exists, we can install the dependencies of the project with:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install . --deps-only</span></span></code></pre></div><h3 id="add-new-packages" tabindex="-1">Add new packages <a class="header-anchor" href="#add-new-packages" aria-label="Permalink to &quot;Add new packages&quot;">​</a></h3><p>To add a new package to the opam switch, we can do:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">package_nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>But opam will not modify the <code>app.opam</code> file during the installation, this has to be done by hand, by adding the name of the package in the <code>depends</code> field.</p><h3 id="linking-packages-for-development" tabindex="-1">Linking packages for development <a class="header-anchor" href="#linking-packages-for-development" aria-label="Permalink to &quot;Linking packages for development&quot;">​</a></h3><p>This can be achieved with <code>opam pin</code>. For example, to pin a package to a specific commit on GitHub:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pin add reason-react.dev https://github.com/reasonml/reason-react.git#61bfbfaf8c971dec5152bce7e528d30552c70bc5</span></span></code></pre></div><p>Branch names can also be used.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pin add reason-react.dev https://github.com/reasonml/reason-react.git#feature</span></span></code></pre></div><p>For packages that are already published in the opam repository, a shortcut to pin to the latest version is to use the <code>--dev-repo</code> flag, e.g.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pin add melange.dev --dev-repo</span></span></code></pre></div><p>To remove the pinning for any package, use <code>opam unpin &lt;package_name&gt;</code> or <code>opam pin remove &lt;package_name&gt;</code>.</p><p>For other options, the command is well described in <a href="https://opam.ocaml.org/doc/Usage.html#opam-pin" target="_blank" rel="noreferrer">the official documentation</a>.</p><h3 id="upgrading-packages" tabindex="-1">Upgrading packages <a class="header-anchor" href="#upgrading-packages" aria-label="Permalink to &quot;Upgrading packages&quot;">​</a></h3><p>There is one big difference compared to npm: opam stores a local copy of the opam repository, like <code>apt-get</code> does in Debian. So before doing any upgrades, we might want to update this copy before:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span></code></pre></div><p>Then, to upgrade the installed packages to the latest version, run:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">package_nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p><code>opam upgrade</code> is also able to upgrade <em>all</em> the packages of the local switch if no package name is given.</p><h3 id="dev-dependencies" tabindex="-1">Dev dependencies <a class="header-anchor" href="#dev-dependencies" aria-label="Permalink to &quot;Dev dependencies&quot;">​</a></h3><p>You can use the <a href="https://opam.ocaml.org/doc/Manual.html#pkgvar-with-dev-setup" target="_blank" rel="noreferrer"><code>with-dev-setup</code> field</a> to define dependencies that are only required at development time. For example:</p><div class="language-opam vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">opam</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">depends</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;ocamlformat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">with-dev-setup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>This has to be combined with the <code>--with-dev-setup</code> flag when installing dependencies, e.g. <code>opam install --deps-only --with-dev-setup</code>.</p><h3 id="lock-files" tabindex="-1">Lock files <a class="header-anchor" href="#lock-files" aria-label="Permalink to &quot;Lock files&quot;">​</a></h3><p>Lock files aren’t as used in the opam world as somewhere else, but they can be used as follows:</p><ul><li>Using <code>opam lock</code> to generate the lock file when needed (basically after each <code>opam install</code> or <code>opam upgrade</code>).</li><li>Adding <code>--locked</code> to all the <code>opam install --deps-only</code> and <code>opam switch create .</code> commands.</li></ul><h3 id="bindings-and-package-management" tabindex="-1">Bindings and package management <a class="header-anchor" href="#bindings-and-package-management" aria-label="Permalink to &quot;Bindings and package management&quot;">​</a></h3><p>When writing Melange libraries that bind to existing JavaScript packages, the users of the Melange library will have to make sure that those JavaScript packages are installed.</p><p>This is similar to how OCaml bindings to system libraries work, see examples like <a href="https://github.com/andrenth/ocaml-mariadb/blob/9db2e4d8dec7c584213d0e0f03d079a36a35d9d5/README.md?plain=1#L18-L20" target="_blank" rel="noreferrer"><code>ocaml-mariadb</code></a> or <a href="https://github.com/ygrek/ocurl/blob/f0c6f47d6f3d25282648439dc4ade5810a993710/README.md?plain=1#L16" target="_blank" rel="noreferrer"><code>ocurl</code></a>.</p><p>The advantage of this approach —as opposed to vendoring the JavaScript packages inside the bindings— is that it gives users of the bindings complete flexibility over the way these JavaScript packages are downloaded and bundled.</p><p>Melange provides a way to define dependencies from opam packages to npm packages inside the <code>opam</code> files through the <a href="https://github.com/jchavarri/opam-check-npm-deps" target="_blank" rel="noreferrer">check-npm-deps</a> opam plugin.</p><p>With this plugin, library authors can include constraints in the npm format inside the opam <code>depexts</code> field, for example, the <code>reason-react</code> opam file can include a section like this:</p><div class="language-opam vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">opam</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">depexts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;react&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;react-dom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] {</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">npm-version</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;^17.0.0 || ^18.0.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>This indicates that the version of <code>reason-react</code> is compatible with ReactJS versions 17 and 18.</p><p>Users of Melange bindings can check that the constraints defined in the opam packages installed in their switch are fulfilled by the packages installed in <code>node_modules</code> by using the <code>check-npm-deps</code> plugin. For this, one just needs to install the plugin:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install opam-check-npm-deps</span></span></code></pre></div><p>And then call it from the root folder of the project, where the opam switch and the <code>node_modules</code> folder exist:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opam-check-npm-deps</span></span></code></pre></div><h2 id="finding-and-using-melange-compatible-packages" tabindex="-1">Finding and using Melange compatible packages <a class="header-anchor" href="#finding-and-using-melange-compatible-packages" aria-label="Permalink to &quot;Finding and using Melange compatible packages&quot;">​</a></h2><h3 id="opam-packages" tabindex="-1">opam packages <a class="header-anchor" href="#opam-packages" aria-label="Permalink to &quot;opam packages&quot;">​</a></h3><p>Melange packages are usually available on <a href="https://opam.ocaml.org" target="_blank" rel="noreferrer">opam</a>. Package search is available in the opam CLI via <code>opam search &lt;package-name&gt;</code>, e.g. <code>opam search reason-react</code>. You can run <code>opam install &lt;package-name&gt;</code> to download, build and install opam packages in your switch. Remember that opam won&#39;t automatically add the dependency to <code>&lt;your-project&gt;.opam</code> file, so it must be added manually:</p><div class="language-opam vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">opam</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">depends</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;reason-react&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0.11.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>To use a library from the installed package, add the library name to the <code>dune</code> file under the <code>libraries</code> field. For example, if our project structure looks like:</p><div class="language-text vp-adaptive-theme"><pre class="text-ocaml shiki shiki-themes github-light github-dark vp-code"><code>project_name/
├── _opam
├── src
│   ├── dune
│   ├── ReactComponent1.ml
│   ├── ReactComponent2.ml
│   └── lib
│        ├── dune
│        └── data.ml
├── dune-project
├── dune
├── package.json
└── ...</code></pre><pre class="text-reasonml shiki shiki-themes github-light github-dark vp-code"><code>project_name/
├── _opam
├── src
│   ├── dune
│   ├── ReactComponent1.re
│   ├── ReactComponent2.re
│   └── lib
│        ├── dune
│        └── data.re
├── dune-project
├── dune
├── package.json
└── ...</code></pre></div><p>then <code>reason-react</code> should be added to the <code>dune</code> file under the <code>src</code> folder:</p><div class="language-dune vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dune</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">melange.emit</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">alias</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> react)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">libraries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lib reason-react)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">preprocess</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reason-react-ppx))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module_systems</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> es6))</span></span></code></pre></div><p>Some libraries will only work after being processed by an accompanying PPX, e.g., <code>reason-react</code> requires preprocessing with <code>reason-react-ppx</code>. These preprocessors may be installed together with the library as part of the same package, or they might be part of a different package, in which case they need to be installed separately.</p><h3 id="unpublished-opam-packages" tabindex="-1">Unpublished opam packages <a class="header-anchor" href="#unpublished-opam-packages" aria-label="Permalink to &quot;Unpublished opam packages&quot;">​</a></h3><p>opam packages that have not yet been published may be installed with the <code>opam pin</code> command. For example, <code>opam pin add melange-fetch.dev git+https://github.com/melange-community/melange-fetch</code> will obtain <code>melange-fetch</code> from its Git repository and install it on your switch. Your <code>&lt;your-project&gt;.opam</code> file should then be updated in two places:</p><div class="language-opam vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">opam</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">depends</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &quot;melange-fetch&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">pin-depends</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;melange-fetch.dev&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;git+https://github.com/melange-community/melange-fetch&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>Once installed, the libraries included in the package can be added to the <code>dune</code> file:</p><div class="language-dune vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dune</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">melange.emit</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> output)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">alias</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> react)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">libraries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lib reason-react melange-fetch)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">preprocess</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reason-react-ppx))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module_systems</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> es6))</span></span></code></pre></div><h3 id="npm-packages" tabindex="-1">npm packages <a class="header-anchor" href="#npm-packages" aria-label="Permalink to &quot;npm packages&quot;">​</a></h3><p>A number of Melange compatible packages can be found on npm. Many older, but still useful, compatible BuckleScript libraries can be found on npm, e.g., <code>bs-json</code>. Run <code>npm install @glennsl/bs-json</code> to add the dependency locally and record it in the <code>package.json</code> file at the root of our project.</p><p>Dune needs to be made aware of the newly installed package. The <a href="https://dune.readthedocs.io/en/stable/reference/dune/subdir.html" target="_blank" rel="noreferrer"><code>subdir</code></a> stanza can be handy in these cases:</p><div class="language-dune vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dune</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">subdir</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> node_modules</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">dirs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @glennsl)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">subdir</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  @glennsl/bs-json/src</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bs_json)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">wrapped</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">modes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange))))</span></span></code></pre></div><p>If the <code>dune</code> file contains the line <code>(dirs :standard \\ node_modules)</code>, it should be removed, so that Dune can process the new Melange sources under the <code>node_modules</code> folder.</p><p>In our project structure above we have the file <code class="text-ocaml">data.ml</code><code class="text-reasonml">data.re</code> under the folder <code>src/lib</code>. If we want use the <code>bs-json</code> library from within the <code class="text-ocaml">data.ml</code><code class="text-reasonml">data.re</code> file then we need to add the library name to the <code>dune</code> file in the same folder, i.e., <code>src/lib/dune</code>:</p><div class="language-dune vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dune</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">libraries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bs_json)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">modes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange))</span></span></code></pre></div><p>Note that the library <code>bs-json</code> was defined as <code>bs_json</code> in the <code>subdir</code> stanza and is referenced as <code>bs_json</code> in the <code>dune</code> file. This is necessary as Dune wrapped libraries <a href="https://dune.readthedocs.io/en/stable/explanation/ocaml-ecosystem.html#dune-is-opinionated" target="_blank" rel="noreferrer">will only expose a single top-level module</a> named after the library, so the library name has to be a valid module name. This is why library names with characters like <code>-</code> are not valid.</p><p>We can add new <code>subdir</code> stanzas for every package we&#39;d like to consume this way. See <a href="https://github.com/psb/reason-react-hn-melange/blob/9983b26aebd78b445d5f44d66bb6781eccedc787/dune" target="_blank" rel="noreferrer">this dune file</a> for a larger example that uses multiple npm packages.</p>`,100),l=[t];function p(o,h,d,r,c,k){return s(),e("div",null,l)}const u=a(n,[["render",p]]);export{m as __pageData,u as default};
