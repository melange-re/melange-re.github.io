<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>A Preview of Universal Libraries in Dune | Melange</title>
    <meta name="description" content="The official documentation site for Melange, a compiler from OCaml to JavaScript. Explore the features and resources for functional programming with Melange, including the standard libraries APIs, the playground, and extensive documentation about bindings, build system, and the opam package manager.">
    <meta name="generator" content="VitePress v1.0.0-rc.42">
    <link rel="preload stylesheet" href="/unstable/assets/style.obAEt0M9.css" as="style">
    
    <script type="module" src="/unstable/assets/app.XHv-cbLj.js"></script>
    <link rel="preload" href="/unstable/assets/inter-roman-latin.bvIUbFQP.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/unstable/assets/chunks/framework.Jc2EC4h_.js">
    <link rel="modulepreload" href="/unstable/assets/chunks/theme.R2eWykVq.js">
    <link rel="modulepreload" href="/unstable/assets/blog_posts_dune-universal-libraries-preview.md.R7IzP2f8.lean.js">
    <script>document.addEventListener("DOMContentLoaded",()=>{const e=["reasonml","ocaml"],n="syntax__";let t;((a=e[0])=>{document.body.classList.remove(`${n}${t}`),document.body.classList.add(`${n}${a}`),t=a,localStorage.setItem("syntax",t)})(localStorage.getItem("syntax",t)||e[0])});</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout blog-layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-19c990f1><div class="wrapper" data-v-19c990f1><div class="container" data-v-19c990f1><div class="title" data-v-19c990f1><div class="VPNavBarTitle" data-v-19c990f1 data-v-ab179fa1><a class="title" href="/unstable/" data-v-ab179fa1><!--[--><!--]--><!----><span data-v-ab179fa1>Melange</span><!--[--><!--]--></a></div></div><div class="content" data-v-19c990f1><div class="content-body" data-v-19c990f1><!--[--><!--]--><div class="VPNavBarSearch search" data-v-19c990f1><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-19c990f1 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/unstable/what-is-melange" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Learn</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/unstable/api" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>API</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/unstable/playground/" target="_self" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Playground</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://react-book.melange.re" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Book</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://melange.re/blog/" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Blog</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-9c007e85><span class="text" data-v-9c007e85><!----><span data-v-9c007e85>unstable</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-9c007e85><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://melange.re/v4.0.0/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->v4.0.0<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://melange.re/v3.0.0/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->v3.0.0<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://melange.re/v2.2.0/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->v2.2.0<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://melange.re/v2.1.0/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->v2.1.0<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://melange.re/v2.0.0/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->v2.0.0<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-e7ea1737 data-v-43f1e123><a class="VPLink link vp-external-link-icon" href="https://melange.re/v1.0.0/" target="_blank" rel="noreferrer" data-v-43f1e123><!--[-->v1.0.0<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-19c990f1 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-e6aabb21 data-v-1736f215 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1736f215><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1736f215><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-19c990f1 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/melange-re/melange" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-19c990f1 data-v-d0bd9dde data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d0bd9dde data-v-1736f215 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1736f215><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1736f215><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/melange-re/melange" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-19c990f1 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-19c990f1><div class="divider-line" data-v-19c990f1></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-5d98c3a5 data-v-0282ae07><div class="container" data-v-0282ae07><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-0282ae07 data-v-af18c0d5><button data-v-af18c0d5>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-935f8a84><div class="content" data-v-935f8a84><div class="outline-marker" data-v-935f8a84></div><div class="outline-title" role="heading" aria-level="2" data-v-935f8a84>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-935f8a84><span class="visually-hidden" id="doc-outline-aria-label" data-v-935f8a84> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-935f8a84 data-v-b933a997><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _unstable_blog_posts_dune-universal-libraries-preview" data-v-39a288b8><div><p>I recently shared a <a href="./whats-2024-brought-to-melange-so-far">2024 progress update</a> about our work on Melange. In that message, I briefly wrote about &quot;universal libraries&quot; in Dune, the ability to write a shared OCaml / Melange codebase while varying specific module implementations, flags, preprocessing steps, etc. according to the compilation target.</p><p>I also promised to dive deeper into what &quot;universal libraries&quot; are all about, and the new use cases that they unlock in Dune. Keep reading for an in-depth look at the history behind this new feature rolling out in Dune 3.16.</p><hr><h2 id="the-bird-s-eye-view" tabindex="-1">The Bird&#39;s-eye View <a class="header-anchor" href="#the-bird-s-eye-view" aria-label="Permalink to &quot;The Bird&#39;s-eye View&quot;">​</a></h2><p>Let&#39;s walk backwards from our end-goal: having a shared OCaml / Melange codebase that can render React.js components on the server, such that the <a href="https://ahrefs.com" target="_blank" rel="noreferrer">Ahrefs</a> website can be rendered on the server without JavaScript. And, finally, having React.js hydrate the server-rendered HTML in the browser. <a href="https://twitter.com/davesnx" target="_blank" rel="noreferrer">Dave</a> explains the motivation behind this goal in more depth <a href="https://sancho.dev/blog/server-side-rendering-react-in-ocaml" target="_blank" rel="noreferrer">in his blog </a>.</p><p>To look at a specific example, we&#39;ll start with a Melange codebase already using <a href="https://github.com/reasonml/reason-react" target="_blank" rel="noreferrer"><code>reason-react</code></a>. Our goal is to get those <code>reason-react</code> components to compile server-side with the OCaml compiler, where we&#39;ll use <a href="https://github.com/ml-in-barcelona/server-reason-react" target="_blank" rel="noreferrer"><code>server-reason-react</code></a> as a drop-in replacement for <code>reason-react</code>.</p><p>What gets in our way is that:</p><ul><li>not everything is supported on both sides: some Melange modules use APIs that don&#39;t exist in OCaml (and extensive shimming is undesirable). <ul><li>vice-versa on the Melange side; especially code that calls into C bindings.</li></ul></li><li>we can&#39;t choose what implementation to use inside a module or conditionally apply different preprocessing steps and/or flags.</li></ul><p>In summary, we would like to vary specific module implementations across the same library, based on their compilation target. If we try to use it in a real-world codebase, we&#39;ll also find the need to specify different preprocessing definitions, compilation flags, the set of modules belonging to the library – effectively most fields in the <code>(library ..)</code> stanza.</p><h2 id="a-first-hack-approach" tabindex="-1">A First <s>Hack</s> Approach <a class="header-anchor" href="#a-first-hack-approach" aria-label="Permalink to &quot;A First ~~Hack~~ Approach&quot;">​</a></h2><p>We concluded that it would be desirable to write two library definitions. That would allow us to configure each <code>(library ..)</code> stanza field separately, achieving our goal.</p><p>But Dune doesn&#39;t allow you to have two libraries with the same name. How could it? If Dune derives the artifact directory for libraries from their <code>(name ..)</code> field, two conflicting names compete for the same artifact directory.</p><p>So we first tried to work around that, and set up:</p><ul><li>unwrapped (<code>(wrapped false)</code>) Dune libraries with different names <ul><li>with unwrapped libraries, we could share modules across compilation targets, e.g. <code>react.ml</code> originating from both <code>reason-react</code> and <code>server-reason-react</code>;</li></ul></li><li>defined in different directories;</li><li><code>(copy_files ..)</code> from one of the directories into the other, duplicating shared modules. <ul><li>Modules with the same name and different implementations, specific to each directory.</li></ul></li></ul><div class="language-clj vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">clj</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; native/dune</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> native_lib)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapped</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; melange/dune</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange_lib)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapped</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; Copy modules `A` and `B` from `../native`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_files#</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ../native</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {a,b}.ml{,i}))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; module `C` has a specific Melange implementation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with-stdout-to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.ml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;let backend = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">melange</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span></code></pre></div><p>This worked until it didn&#39;t: we quickly ran into a limitation in <code>(copy_files ..)</code> (<a href="https://github.com/ocaml/dune/issues/9709" target="_blank" rel="noreferrer">dune#9709</a>). Because this stanza operates in the build directory, it was impossible to exclude some of build artifacts that get generated with <code>.ml{,i}</code> extensions from the copy glob – Dune uses extensions such as <code>.pp.ml</code> and <code>.re.pp.ml</code> as targets of its <a href="https://dune.readthedocs.io/en/stable/overview.html#term-dialect" target="_blank" rel="noreferrer">dialect</a> and <a href="https://dune.readthedocs.io/en/stable/reference/preprocessing-spec.html" target="_blank" rel="noreferrer">preprocessing</a> phases.</p><h2 id="limiting-copy-files-to-source-files-only" tabindex="-1">Limiting <code>(copy_files ..)</code> to source-files only <a class="header-anchor" href="#limiting-copy-files-to-source-files-only" aria-label="Permalink to &quot;Limiting `(copy_files ..)` to source-files only&quot;">​</a></h2><p>What we would want from <code>copy_files</code> in our scenario is the ability to limit copying only to files that are present in source. That way we can address all the <code>.re{,i}</code> and <code>.ml{,i}</code> files in source directories without worrying about polluting our target directories with some intermediate Dune targets.</p><p>In <a href="https://github.com/ocaml/dune/pull/9827" target="_blank" rel="noreferrer">dune#9827</a>, we added a new option to <code>copy_files</code> that allows precisely that: if the field <code>(only_sources &lt;optional_boolean_language&gt;)</code> is present, Dune will only match files in the source directory, and won&#39;t apply the glob to the targets of rules.</p><p>After this change, our Dune file just needs to contemplate one more line:</p><div class="language-diff vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;; Copy modules `A` and `B` from `../native`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (copy_files# ../native</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">+ (only_sources)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (files {a,b}.ml{,i}))</span></span></code></pre></div><h2 id="checkpoint" tabindex="-1">Checkpoint <a class="header-anchor" href="#checkpoint" aria-label="Permalink to &quot;Checkpoint&quot;">​</a></h2><p>Our Dune file allows us to move forward. We were now able to define multiple libraries that share common implementations across native code and Melange. Though library names still need to be different. And, overall, we still face some other glaring limitations:</p><ul><li>The <code>(wrapped false)</code> requirement makes it impossible to namespace these libraries;</li><li>Defining libraries in different directories and using <code>copy_files</code> places extra separation between common implementations, and adds extra build configuration overhead;</li><li>Publishing a library with <code>(modes :standard melange)</code> adds a non-optional dependency on Melange, which should really be optional for native-only consumers.</li><li>Extensive usage of <code>(copy_files ..)</code> as shared in the example above breaks editor integration and &quot;jump to definition&quot;; Merlin and OCaml-LSP don&#39;t track the original source in this scenario.</li></ul><h2 id="testing-a-new-solution" tabindex="-1">Testing a New Solution <a class="header-anchor" href="#testing-a-new-solution" aria-label="Permalink to &quot;Testing a New Solution&quot;">​</a></h2><p>We became intentful on removing these limitations, and realized at some point that our use case is somewhat similar to cross-compilation, which Dune <a href="https://dune.readthedocs.io/en/stable/cross-compilation.html" target="_blank" rel="noreferrer">already supports well</a>. The key insight, which we shared in a Dune proposal (<a href="https://github.com/ocaml/dune/issues/10222" target="_blank" rel="noreferrer">dune#10222</a>), is that we could share library names as long as they resolved to a single library per <a href="https://dune.readthedocs.io/en/stable/reference/dune-workspace/context.html" target="_blank" rel="noreferrer">build context</a>.</p><p>After making the proposed changes to Dune (<a href="https://github.com/ocaml/dune/pull/10220" target="_blank" rel="noreferrer">dune#10220</a>, <a href="https://github.com/ocaml/dune/pull/10307" target="_blank" rel="noreferrer">dune#10307</a>, <a href="https://github.com/ocaml/dune/pull/10354" target="_blank" rel="noreferrer">dune#10354</a>, <a href="https://github.com/ocaml/dune/pull/10355" target="_blank" rel="noreferrer">dune#10355</a>) we found ourselves having implemented support for:</p><ul><li>Dune libraries with the same name;</li><li>which may be defined in the same directory;</li><li>as long as they don&#39;t conflict in the same context. <ul><li>to achieve that, we use e.g. <code>(enabled_if (= %{context_name} melange))</code>.</li></ul></li></ul><p>Putting it all together, our example can be adapted to look like:</p><div class="language-clj vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">clj</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; src/dune</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; can also be defined in src/dune(!)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} melange)))</span></span></code></pre></div><p>In other words, we define two libraries named <code>a</code>, each in their own build context (with build artifacts ending up in <code>_build/default</code> and <code>_build/melange</code>). In the <code>melange</code> context, the library has <code>(modes melange)</code>.</p><p>Both libraries contain modules <code>A</code>, <code>B</code> and <code>C</code> like before. Their corresponding source files can live in a single directory, no copying required. If we need to vary <code>C</code>&#39;s implementation, we can express that in Dune rules:</p><div class="language-clj vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">clj</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.native.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">action</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with-stdout-to</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   %{target}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;let backend = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">OCaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.melange.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">action</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with-stdout-to</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   %{target}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;let backend = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Melange</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} melange)))</span></span></code></pre></div><p>In short, both libraries get a module <code>C</code>. <code>c.ml</code>&#39;s contents vary according to the build context. The example above is currently illustrative, even if functional. We&#39;re still working on the developer experience of multi-context libraries. This might not be the best setup for editor support, which we&#39;ll find out as we take it for a spin.</p><h2 id="missing-pieces" tabindex="-1">Missing Pieces <a class="header-anchor" href="#missing-pieces" aria-label="Permalink to &quot;Missing Pieces&quot;">​</a></h2><p>We proved that compiling libraries with the same name in different contexts can work after migrating some of the libraries to the new configuration.</p><p>Before deploying such a major change at scale, we need to get the developer experience right. To illustrate some examples:</p><ul><li><a href="https://github.com/ocaml/dune/pull/10324" target="_blank" rel="noreferrer">Dune</a> and <a href="https://github.com/ocaml/ocaml-lsp/pull/1238" target="_blank" rel="noreferrer"><code>ocaml-lsp</code></a> must support selecting the context to know where to look for compiled artifacts;</li><li>Editor plugins must have commands or configuration associating certain files with their respective context;</li><li>Dune can do better to <a href="https://github.com/ocaml/dune/issues/10378" target="_blank" rel="noreferrer">show the context</a> to which errors belong</li></ul><p>We will need some additional time to let all pieces fall in their right places before we can start recommending compiling Melange code in a separate Dune context. Before that happens, we wanted to share the problems we faced, how we ended up lifting some interesting limitations in a composable way, and the new constructs that will be available in Dune 3.16.</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-48f9bb55><!--[--><!--]--><div class="edit-info" data-v-48f9bb55><div class="edit-link" data-v-48f9bb55><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/melange-re/melange-re.github.io/edit/master/docs/blog/posts/dune-universal-libraries-preview.md" target="_blank" rel="noreferrer" data-v-48f9bb55><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-48f9bb55><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> Edit this page<!--]--></a></div><!----></div><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><main class="blog-main"><div class="blog-content-area"><article class="xl:divide-y xl:divide-gray-200 dark:xl:divide-slate-200/5"><header class="pt-6 xl:pb-10 space-y-1 text-center"><dl><dt class="sr-only">Published on</dt><dd class="text-base leading-6 font-medium text-gray-500 dark:text-gray-300"><time datetime="2024-04-10T12:00:00.000Z">April 10, 2024</time></dd></dl><h1 class="text-3xl leading-9 font-extrabold text-gray-900 dark:text-white tracking-tight sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">A Preview of Universal Libraries in Dune</h1></header><div class="divide-y xl:divide-y-0 divide-gray-200 dark:divide-slate-200/5 xl:grid xl:grid-cols-4 xl:gap-x-10 pb-16 xl:pb-20" style="grid-template-rows:auto 1fr;"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 dark:xl:border-slate-200/5"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center xl:block space-x-8 sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="https://gravatar.com/avatar/45c2052f50f561b9dc2cae59c777aecd794f57269fa317f9c9c3365c2e00d16f" alt="author image" class="w-10 h-10 rounded-full"><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-white">Antonio Monteiro</dd><dt class="sr-only">Twitter</dt><dd><a href="https://twitter.com/@_anmonteiro" target="_blank" rel="noopnener noreferrer" class="link">@_anmonteiro</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-slate-200/5 xl:pb-0 xl:col-span-3 xl:row-span-2"><div style="position:relative;" class="prose dark:prose-invert max-w-none pt-10 pb-8"><div><p>I recently shared a <a href="./whats-2024-brought-to-melange-so-far">2024 progress update</a> about our work on Melange. In that message, I briefly wrote about &quot;universal libraries&quot; in Dune, the ability to write a shared OCaml / Melange codebase while varying specific module implementations, flags, preprocessing steps, etc. according to the compilation target.</p><p>I also promised to dive deeper into what &quot;universal libraries&quot; are all about, and the new use cases that they unlock in Dune. Keep reading for an in-depth look at the history behind this new feature rolling out in Dune 3.16.</p><hr><h2 id="the-bird-s-eye-view" tabindex="-1">The Bird&#39;s-eye View <a class="header-anchor" href="#the-bird-s-eye-view" aria-label="Permalink to &quot;The Bird&#39;s-eye View&quot;">​</a></h2><p>Let&#39;s walk backwards from our end-goal: having a shared OCaml / Melange codebase that can render React.js components on the server, such that the <a href="https://ahrefs.com" target="_blank" rel="noreferrer">Ahrefs</a> website can be rendered on the server without JavaScript. And, finally, having React.js hydrate the server-rendered HTML in the browser. <a href="https://twitter.com/davesnx" target="_blank" rel="noreferrer">Dave</a> explains the motivation behind this goal in more depth <a href="https://sancho.dev/blog/server-side-rendering-react-in-ocaml" target="_blank" rel="noreferrer">in his blog </a>.</p><p>To look at a specific example, we&#39;ll start with a Melange codebase already using <a href="https://github.com/reasonml/reason-react" target="_blank" rel="noreferrer"><code>reason-react</code></a>. Our goal is to get those <code>reason-react</code> components to compile server-side with the OCaml compiler, where we&#39;ll use <a href="https://github.com/ml-in-barcelona/server-reason-react" target="_blank" rel="noreferrer"><code>server-reason-react</code></a> as a drop-in replacement for <code>reason-react</code>.</p><p>What gets in our way is that:</p><ul><li>not everything is supported on both sides: some Melange modules use APIs that don&#39;t exist in OCaml (and extensive shimming is undesirable). <ul><li>vice-versa on the Melange side; especially code that calls into C bindings.</li></ul></li><li>we can&#39;t choose what implementation to use inside a module or conditionally apply different preprocessing steps and/or flags.</li></ul><p>In summary, we would like to vary specific module implementations across the same library, based on their compilation target. If we try to use it in a real-world codebase, we&#39;ll also find the need to specify different preprocessing definitions, compilation flags, the set of modules belonging to the library – effectively most fields in the <code>(library ..)</code> stanza.</p><h2 id="a-first-hack-approach" tabindex="-1">A First <s>Hack</s> Approach <a class="header-anchor" href="#a-first-hack-approach" aria-label="Permalink to &quot;A First ~~Hack~~ Approach&quot;">​</a></h2><p>We concluded that it would be desirable to write two library definitions. That would allow us to configure each <code>(library ..)</code> stanza field separately, achieving our goal.</p><p>But Dune doesn&#39;t allow you to have two libraries with the same name. How could it? If Dune derives the artifact directory for libraries from their <code>(name ..)</code> field, two conflicting names compete for the same artifact directory.</p><p>So we first tried to work around that, and set up:</p><ul><li>unwrapped (<code>(wrapped false)</code>) Dune libraries with different names <ul><li>with unwrapped libraries, we could share modules across compilation targets, e.g. <code>react.ml</code> originating from both <code>reason-react</code> and <code>server-reason-react</code>;</li></ul></li><li>defined in different directories;</li><li><code>(copy_files ..)</code> from one of the directories into the other, duplicating shared modules. <ul><li>Modules with the same name and different implementations, specific to each directory.</li></ul></li></ul><div class="language-clj vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">clj</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; native/dune</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> native_lib)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapped</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; melange/dune</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange_lib)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrapped</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; Copy modules `A` and `B` from `../native`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_files#</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ../native</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {a,b}.ml{,i}))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; module `C` has a specific Melange implementation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with-stdout-to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.ml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;let backend = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">melange</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span></code></pre></div><p>This worked until it didn&#39;t: we quickly ran into a limitation in <code>(copy_files ..)</code> (<a href="https://github.com/ocaml/dune/issues/9709" target="_blank" rel="noreferrer">dune#9709</a>). Because this stanza operates in the build directory, it was impossible to exclude some of build artifacts that get generated with <code>.ml{,i}</code> extensions from the copy glob – Dune uses extensions such as <code>.pp.ml</code> and <code>.re.pp.ml</code> as targets of its <a href="https://dune.readthedocs.io/en/stable/overview.html#term-dialect" target="_blank" rel="noreferrer">dialect</a> and <a href="https://dune.readthedocs.io/en/stable/reference/preprocessing-spec.html" target="_blank" rel="noreferrer">preprocessing</a> phases.</p><h2 id="limiting-copy-files-to-source-files-only" tabindex="-1">Limiting <code>(copy_files ..)</code> to source-files only <a class="header-anchor" href="#limiting-copy-files-to-source-files-only" aria-label="Permalink to &quot;Limiting `(copy_files ..)` to source-files only&quot;">​</a></h2><p>What we would want from <code>copy_files</code> in our scenario is the ability to limit copying only to files that are present in source. That way we can address all the <code>.re{,i}</code> and <code>.ml{,i}</code> files in source directories without worrying about polluting our target directories with some intermediate Dune targets.</p><p>In <a href="https://github.com/ocaml/dune/pull/9827" target="_blank" rel="noreferrer">dune#9827</a>, we added a new option to <code>copy_files</code> that allows precisely that: if the field <code>(only_sources &lt;optional_boolean_language&gt;)</code> is present, Dune will only match files in the source directory, and won&#39;t apply the glob to the targets of rules.</p><p>After this change, our Dune file just needs to contemplate one more line:</p><div class="language-diff vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ;; Copy modules `A` and `B` from `../native`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (copy_files# ../native</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">+ (only_sources)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (files {a,b}.ml{,i}))</span></span></code></pre></div><h2 id="checkpoint" tabindex="-1">Checkpoint <a class="header-anchor" href="#checkpoint" aria-label="Permalink to &quot;Checkpoint&quot;">​</a></h2><p>Our Dune file allows us to move forward. We were now able to define multiple libraries that share common implementations across native code and Melange. Though library names still need to be different. And, overall, we still face some other glaring limitations:</p><ul><li>The <code>(wrapped false)</code> requirement makes it impossible to namespace these libraries;</li><li>Defining libraries in different directories and using <code>copy_files</code> places extra separation between common implementations, and adds extra build configuration overhead;</li><li>Publishing a library with <code>(modes :standard melange)</code> adds a non-optional dependency on Melange, which should really be optional for native-only consumers.</li><li>Extensive usage of <code>(copy_files ..)</code> as shared in the example above breaks editor integration and &quot;jump to definition&quot;; Merlin and OCaml-LSP don&#39;t track the original source in this scenario.</li></ul><h2 id="testing-a-new-solution" tabindex="-1">Testing a New Solution <a class="header-anchor" href="#testing-a-new-solution" aria-label="Permalink to &quot;Testing a New Solution&quot;">​</a></h2><p>We became intentful on removing these limitations, and realized at some point that our use case is somewhat similar to cross-compilation, which Dune <a href="https://dune.readthedocs.io/en/stable/cross-compilation.html" target="_blank" rel="noreferrer">already supports well</a>. The key insight, which we shared in a Dune proposal (<a href="https://github.com/ocaml/dune/issues/10222" target="_blank" rel="noreferrer">dune#10222</a>), is that we could share library names as long as they resolved to a single library per <a href="https://dune.readthedocs.io/en/stable/reference/dune-workspace/context.html" target="_blank" rel="noreferrer">build context</a>.</p><p>After making the proposed changes to Dune (<a href="https://github.com/ocaml/dune/pull/10220" target="_blank" rel="noreferrer">dune#10220</a>, <a href="https://github.com/ocaml/dune/pull/10307" target="_blank" rel="noreferrer">dune#10307</a>, <a href="https://github.com/ocaml/dune/pull/10354" target="_blank" rel="noreferrer">dune#10354</a>, <a href="https://github.com/ocaml/dune/pull/10355" target="_blank" rel="noreferrer">dune#10355</a>) we found ourselves having implemented support for:</p><ul><li>Dune libraries with the same name;</li><li>which may be defined in the same directory;</li><li>as long as they don&#39;t conflict in the same context. <ul><li>to achieve that, we use e.g. <code>(enabled_if (= %{context_name} melange))</code>.</li></ul></li></ul><p>Putting it all together, our example can be adapted to look like:</p><div class="language-clj vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">clj</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; src/dune</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">;; can also be defined in src/dune(!)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">library</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> melange)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a b c)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} melange)))</span></span></code></pre></div><p>In other words, we define two libraries named <code>a</code>, each in their own build context (with build artifacts ending up in <code>_build/default</code> and <code>_build/melange</code>). In the <code>melange</code> context, the library has <code>(modes melange)</code>.</p><p>Both libraries contain modules <code>A</code>, <code>B</code> and <code>C</code> like before. Their corresponding source files can live in a single directory, no copying required. If we need to vary <code>C</code>&#39;s implementation, we can express that in Dune rules:</p><div class="language-clj vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">clj</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.native.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">action</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with-stdout-to</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   %{target}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;let backend = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">OCaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rule</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">target</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.melange.ml)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">action</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with-stdout-to</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   %{target}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;let backend = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Melange</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled_if</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> %{context_name} melange)))</span></span></code></pre></div><p>In short, both libraries get a module <code>C</code>. <code>c.ml</code>&#39;s contents vary according to the build context. The example above is currently illustrative, even if functional. We&#39;re still working on the developer experience of multi-context libraries. This might not be the best setup for editor support, which we&#39;ll find out as we take it for a spin.</p><h2 id="missing-pieces" tabindex="-1">Missing Pieces <a class="header-anchor" href="#missing-pieces" aria-label="Permalink to &quot;Missing Pieces&quot;">​</a></h2><p>We proved that compiling libraries with the same name in different contexts can work after migrating some of the libraries to the new configuration.</p><p>Before deploying such a major change at scale, we need to get the developer experience right. To illustrate some examples:</p><ul><li><a href="https://github.com/ocaml/dune/pull/10324" target="_blank" rel="noreferrer">Dune</a> and <a href="https://github.com/ocaml/ocaml-lsp/pull/1238" target="_blank" rel="noreferrer"><code>ocaml-lsp</code></a> must support selecting the context to know where to look for compiled artifacts;</li><li>Editor plugins must have commands or configuration associating certain files with their respective context;</li><li>Dune can do better to <a href="https://github.com/ocaml/dune/issues/10378" target="_blank" rel="noreferrer">show the context</a> to which errors belong</li></ul><p>We will need some additional time to let all pieces fall in their right places before we can start recommending compiling Melange code in a separate Dune context. Before that happens, we wanted to share the problems we faced, how we ended up lifting some interesting limitations in a composable way, and the new constructs that will be available in Dune 3.16.</p></div></div></div><footer class="text-sm font-medium leading-5 divide-y divide-gray-200 dark:divide-slate-200/5 xl:col-start-1 xl:row-start-2"><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Next Article </h2><div class="link"><a href="/blog/posts/melange-4-is-here">Melange 4.0 is here</a></div></div><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Previous Article </h2><div class="link"><a href="/blog/posts/whats-2024-brought-to-melange-so-far">What&#39;s 2024 brought to Melange so far?</a></div></div><div class="pt-8"><a class="link" href="/blog/">← Back to the blog</a></div></footer></div></article></div></main><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api.md\":\"Va0kQ81K\",\"api_ml_melange_belt-id-makecomparable-argument-1-m.md\":\"4Pkn5v7h\",\"api_ml_melange_belt-id-makecomparable.md\":\"fXzYP2_b\",\"api_ml_melange_belt-id-makehashable-argument-1-m.md\":\"Q2dSkrUH\",\"api_ml_melange_belt-id-makehashable.md\":\"BsbcbM5T\",\"api_ml_melange_belt-hashmap.md\":\"fB1Ga1G5\",\"api_ml_melange_belt-id-makecomparableu.md\":\"LiSj1pWm\",\"api_ml_melange_belt-id-makehashableu-argument-1-m.md\":\"oLE0tyHa\",\"api_ml_melange_belt-mutablequeue.md\":\"LfuCgcAV\",\"api_ml_melange_belt-map-int.md\":\"7yer-x7D\",\"api_ml_melange_belt.md\":\"-iwBNJEy\",\"api_ml_melange_belt-mutablemap-int.md\":\"QoX-RsOJ\",\"api_ml_melange_belt-id-makehashableu.md\":\"gn4k9BG0\",\"api_ml_melange_belt-sortarray.md\":\"3054AgFK\",\"api_ml_melange_belt-hashmap-int.md\":\"6JjDcJAY\",\"api_ml_melange_belt-hashset.md\":\"AvsGCnrm\",\"api_ml_melange_belt-mutableset-string.md\":\"bwRJup-N\",\"api_ml_melange_belt-id.md\":\"J_8yhtfP\",\"api_ml_melange_belt-int.md\":\"Ru-LkWY1\",\"api_ml_melange_js-blob.md\":\"7UjgCMBj\",\"api_ml_melange_belt-map.md\":\"dXhIx2HH\",\"api_ml_melange_js-array.md\":\"wjVZzUHG\",\"api_ml_melange_js-formdata.md\":\"qfEXQD5H\",\"api_ml_melange_js-float.md\":\"_Bz6eGJV\",\"api_ml_melange_belt-set-int.md\":\"IxAAlOjP\",\"api_ml_melange_js-file.md\":\"ohYQf_tY\",\"api_ml_melange_belt-set-string.md\":\"Nx_gUdOI\",\"api_ml_melange_js-console.md\":\"hljln2dm\",\"api_ml_melange_belt-id-makecomparableu-argument-1-m.md\":\"gQW6aGvy\",\"api_ml_melange_belt-hashmap-string.md\":\"oQGZRxt0\",\"api_ml_melange_belt-sortarray-string.md\":\"ITN58HxU\",\"api_ml_melange_js-date.md\":\"LZxM61BC\",\"api_ml_melange_js-dict.md\":\"7kEgaief\",\"api_ml_melange_belt-id-module-type-comparable.md\":\"RQffINCM\",\"api_ml_melange_belt-range.md\":\"7wM3-hBr\",\"api_ml_melange_js-math.md\":\"48vkLfxA\",\"api_ml_melange_dom-storage.md\":\"4Vmscry0\",\"api_ml_melange_belt-set.md\":\"CK_LKZ8K\",\"api_ml_melange_belt-map-string.md\":\"R_FHU-Fo\",\"api_ml_melange_node-child_process.md\":\"rL6XmtRo\",\"api_ml_melange_node-fs-watch.md\":\"xWs1P78_\",\"api_ml_melange_js.md\":\"BH8_Ij0x\",\"api_ml_melange_node-buffer.md\":\"nDrbymcV\",\"api_ml_melange_node-module.md\":\"OLs2KHjs\",\"api_ml_melange_node-fs.md\":\"mZZH2O9L\",\"api_ml_melange_node-path.md\":\"K8Wezoyz\",\"api_ml_melange_node-process.md\":\"DHQaEjVa\",\"api_ml_melange_js-json.md\":\"BoQpeSFe\",\"api_ml_melange_belt-map-dict.md\":\"arly3ZfG\",\"api_ml_melange_stdlib-arg.md\":\"QCF_Oq4u\",\"api_ml_melange_node.md\":\"gcRMLVWZ\",\"api_ml_melange_stdlib-arraylabels.md\":\"pEUTk0a_\",\"api_ml_melange_stdlib-array.md\":\"qsbKOw1N\",\"api_ml_melange_belt-hashset-int.md\":\"fdJMSB9U\",\"advanced-js-interop.md\":\"Gp5WT7YW\",\"api_ml_melange_belt-mutablestack.md\":\"cx0dsjmz\",\"api_ml_melange_js-iterator.md\":\"7ObwpReh\",\"api_ml_melange_belt-mutablemap.md\":\"FNuo8U5E\",\"api_ml_melange_stdlib-buffer.md\":\"kYunm7LW\",\"api_ml_melange_stdlib-bool.md\":\"S_pw_suG\",\"api_ml_melange_js-exn.md\":\"__b7QqKR\",\"api_ml_melange_belt-mutableset.md\":\"hmjcfz2G\",\"api_ml_melange_js-promise.md\":\"v0TZ-Slr\",\"api_ml_melange_belt-result.md\":\"MBuqvhSG\",\"api_ml_melange_js-map.md\":\"8OIh9a1V\",\"api_ml_melange_js-typed_array-arraybuffer.md\":\"iJ2m3QWh\",\"api_ml_melange_js-obj.md\":\"ABaPYLVC\",\"api_ml_melange_js-global.md\":\"1fNBIGUQ\",\"api_ml_melange_stdlib-dynarray.md\":\"fwopDQ_s\",\"api_ml_melange_belt-option.md\":\"Ca6ulb7o\",\"api_ml_melange_js-typed_array-float64array.md\":\"g34Wnuoe\",\"api_ml_melange_js-set.md\":\"-tvvyA7W\",\"api_ml_melange_belt-mutableset-int.md\":\"lb7CGI5H\",\"api_ml_melange_belt-set-dict.md\":\"1y5YYeDh\",\"api_ml_melange_stdlib-hashtbl-make-argument-1-h.md\":\"taDb7pVI\",\"api_ml_melange_js-typed_array-uint16array.md\":\"TCAfsNQ_\",\"api_ml_melange_stdlib-fun.md\":\"gv1fV7jh\",\"api_ml_melange_stdlib-int64.md\":\"zF4o_Pqc\",\"api_ml_melange_stdlib-hashtbl-module-type-seededs.md\":\"JDQP1CX4\",\"api_ml_melange_stdlib-hashtbl-make.md\":\"J9OzJp2B\",\"api_ml_melange_stdlib-gc-memprof.md\":\"eYQvpj0q\",\"api_ml_melange_js-typed_array-int32array.md\":\"PHnjxof2\",\"api_ml_melange_stdlib-hashtbl-module-type-hashedtype.md\":\"Y2Rd7Bun\",\"api_ml_melange_js-types.md\":\"4BKHJsr0\",\"api_ml_melange_js-typed_array-float32array.md\":\"0TR6xhOP\",\"api_ml_melange_js-bigint.md\":\"pwZFhPpv\",\"api_ml_melange_stdlib-map-make.md\":\"cEAKa2rq\",\"api_ml_melange_stdlib-listlabels.md\":\"9u3Ci4EF\",\"api_ml_melange_stdlib-morelabels-map-module-type-orderedtype.md\":\"j2a_Xt6S\",\"api_ml_melange_stdlib-morelabels-map-make.md\":\"2Ic9oSdK\",\"api_ml_melange_belt-hashset-string.md\":\"YmX06Mn_\",\"api_ml_melange_belt-list.md\":\"mMh6w2DP\",\"api_ml_melange_js-string.md\":\"h3VCiJbZ\",\"api_ml_melange_stdlib-morelabels-set-make-argument-1-ord.md\":\"B6Ol4jEJ\",\"api_ml_melange_stdlib-morelabels-map.md\":\"HRVXJovg\",\"api_ml_melange_stdlib-map.md\":\"CgFHtfrU\",\"api_ml_melange_stdlib-printexc.md\":\"TyXf9e0F\",\"api_ml_melange_stdlib-morelabels-hashtbl-make.md\":\"tesg2DWy\",\"api_ml_melange_stdlib-obj.md\":\"6OEinPfO\",\"api_ml_melange_stdlib-atomic.md\":\"rHeVBSwt\",\"api_ml_melange_stdlib-oo.md\":\"peTOupXV\",\"api_ml_melange_stdlib-option.md\":\"ylKjqdnN\",\"api_ml_melange_stdlib-float.md\":\"bWRX1vZo\",\"api_ml_melange_stdlib-obj-extension_constructor.md\":\"9PsB7bze\",\"api_ml_melange_stdlib-printexc-slot.md\":\"-X0qtEO8\",\"api_ml_melange_stdlib-parsing.md\":\"In92b60N\",\"api_ml_melange_stdlib-out_channel.md\":\"r25rOAK6\",\"api_ml_melange_js-typed_array-uint32array.md\":\"iDWa9wkj\",\"api_ml_melange_js-typed_array-uint8array.md\":\"pNxnFCYJ\",\"api_ml_melange_stdlib-queue.md\":\"mbq7CLix\",\"api_re_melange_belt-result.md\":\"p3N6p5_U\",\"api_ml_melange_stdlib-hashtbl-makeseeded.md\":\"x2ie6Fu4\",\"api_ml_melange_stdlib-lazy.md\":\"uEebhSYZ\",\"api_ml_melange_belt-mutablemap-string.md\":\"BN_GRGuY\",\"api_ml_melange_stdlib-list.md\":\"EFgMDXnr\",\"api_ml_melange_stdlib-lexing.md\":\"fmVsELUC\",\"api_ml_melange_js-typed_array-dataview.md\":\"xY7T8App\",\"api_ml_melange_stdlib-mutex.md\":\"SiSsqLSk\",\"api_ml_melange_stdlib-hashtbl.md\":\"d8_ov-Gu\",\"api_ml_melange_stdlib-largefile.md\":\"0K3b7FOo\",\"api_re_melange_belt-set-string.md\":\"gyohpbs6\",\"api_ml_melange_dom.md\":\"BEORB9jr\",\"api_ml_melange_js-typed_array.md\":\"6TDgQcO5\",\"api_ml_melange_js-typed_array-uint8clampedarray.md\":\"IgcVK_Aj\",\"api_ml_melange_js-weakmap.md\":\"lA3BPpZL\",\"api_ml_melange_stdlib-in_channel.md\":\"Dx7bDM5c\",\"api_ml_melange_stdlib-map-make-argument-1-ord.md\":\"xj37n0t4\",\"api_ml_melange_js-weakset.md\":\"Xsq-6Ftl\",\"api_ml_melange_belt-array.md\":\"lnnI2qq5\",\"api_ml_melange_stdlib-map-module-type-orderedtype.md\":\"XlzH3SLo\",\"api_ml_melange_belt-sortarray-int.md\":\"4tmFX-cI\",\"api_ml_melange_stdlib-marshal.md\":\"gL4HS_9w\",\"api_ml_melange_stdlib-morelabels-hashtbl-make-argument-1-h.md\":\"AWsVp7ze\",\"api_ml_melange_stdlib-int32.md\":\"IzUQUnlV\",\"api_ml_melange_stdlib-map-module-type-s.md\":\"gf3cSCqi\",\"api_ml_melange_stdlib-digest-module-type-s.md\":\"0FAWvOcy\",\"api_ml_melange_stdlib-domain-dls.md\":\"xgpdDdK3\",\"api_ml_melange_stdlib-hashtbl-module-type-s.md\":\"6LhWFGo3\",\"api_ml_melange_stdlib-digest.md\":\"lLjyMUGZ\",\"api_ml_melange_stdlib-domain.md\":\"SzCzfpmm\",\"api_ml_melange_stdlib-morelabels-hashtbl-module-type-hashedtype.md\":\"8VK9zFnV\",\"api_ml_melange_stdlib-bytes.md\":\"nuKJqKYZ\",\"api_ml_melange_stdlib-morelabels-hashtbl-makeseeded.md\":\"XZuYI6WV\",\"api_ml_melange_stdlib-morelabels-hashtbl-module-type-s.md\":\"Am_cU7_R\",\"api_ml_melange_stdlib-printf.md\":\"iVYDOf4A\",\"api_ml_melange_js-int.md\":\"4eBd1OSI\",\"api_re_melange_js-map.md\":\"4OzmRjoc\",\"api_ml_melange_stdlib-digest-blake128.md\":\"SnmCBaUB\",\"api_ml_melange_stdlib-morelabels-hashtbl-module-type-seededhashedtype.md\":\"hYP2-2vS\",\"api_ml_melange_stdlib-hashtbl-module-type-seededhashedtype.md\":\"UIV1lF2e\",\"api_ml_melange_js-typed_array-int16array.md\":\"EO0itWwU\",\"api_ml_melange_stdlib-complex.md\":\"p7zW4KN-\",\"api_re_melange_js-global.md\":\"Lrucsj_3\",\"api_re_melange_js-math.md\":\"NQDKenS3\",\"api_ml_melange_stdlib-obj-ephemeron.md\":\"dIlO6M8g\",\"api_ml_melange_stdlib-morelabels-map-module-type-s.md\":\"NMAaOzuz\",\"api_ml_melange_stdlib-morelabels.md\":\"2_xn4DFL\",\"api_ml_melange_stdlib-morelabels-set-make.md\":\"st_3UC7b\",\"api_ml_melange_stdlib-morelabels-map-make-argument-1-ord.md\":\"FTpx3SpN\",\"api_ml_melange_belt-id-module-type-hashable.md\":\"oxa5chun\",\"api_ml_melange_stdlib-sys-immediate64-make-argument-1-immediate.md\":\"8JyVnVOQ\",\"api_ml_melange_stdlib-sys-immediate64.md\":\"oDlp_gSw\",\"api_ml_melange_stdlib-gc.md\":\"JvkIgYxO\",\"api_ml_melange_stdlib-morelabels-hashtbl.md\":\"03yy-fkO\",\"api_ml_melange_stdlib-seq.md\":\"rGHsJewa\",\"api_ml_melange_stdlib.md\":\"naPKxr9n\",\"api_ml_melange_stdlib-result.md\":\"KWvkl_1Z\",\"api_re_melange_belt-hashmap-string.md\":\"DAhHCDfG\",\"api_re_melange_belt-int.md\":\"aLzL35sf\",\"api_ml_melange_stdlib-set.md\":\"Eq9l1C8l\",\"api_ml_melange_stdlib-random-state.md\":\"l6MDxO2Z\",\"api_ml_melange_stdlib-type-id.md\":\"xHUR1pr1\",\"api_ml_melange_stdlib-set-module-type-s.md\":\"9u3qvcw_\",\"api_ml_melange_stdlib-stack.md\":\"4FBnnPDD\",\"api_ml_melange_stdlib-stdlabels.md\":\"_PhLa_D4\",\"api_ml_melange_stdlib-set-module-type-orderedtype.md\":\"rIkes3gQ\",\"api_re_melange_belt-id-module-type-hashable.md\":\"_hy11fXG\",\"api_re_melange_belt-id-makehashableu-argument-1-m.md\":\"Pub6c2pF\",\"api_re_melange_belt-float.md\":\"iDbfzAqi\",\"api_ml_melange_stdlib-morelabels-set-module-type-s.md\":\"BkZKYHyP\",\"api_ml_melange_stdlib-set-make.md\":\"6VDuYHCP\",\"api_re_melange_js-dict.md\":\"F8NIRBaa\",\"api_re_melange_belt-sortarray.md\":\"c0ulzoQg\",\"api_ml_melange_stdlib-digest-md5.md\":\"dC8OgM9E\",\"api_ml_melange_stdlib-format.md\":\"OHEWZNZy\",\"api_re_melange_belt-option.md\":\"ZOe1Wloj\",\"api_ml_melange_stdlib-sys-immediate64-module-type-immediate.md\":\"lIwwhQj_\",\"api_re_melange_belt-id.md\":\"xb8UmC7p\",\"api_ml_melange_stdlib-either.md\":\"ubvK-VfH\",\"api_re_melange_js-formdata.md\":\"l5XNBtXF\",\"api_re_melange_js-iterator.md\":\"3XXJMtve\",\"api_re_melange_js-console.md\":\"QZ0yytyv\",\"api_re_melange_js-date.md\":\"BkGWSbj7\",\"api_re_melange_js-array.md\":\"R1EB3xpH\",\"api_ml_melange_stdlib-string.md\":\"PWEjpuM9\",\"api_re_melange_js-blob.md\":\"jSCE-3kZ\",\"api_ml_melange_stdlib-sys-immediate64-make.md\":\"Y5uxcADz\",\"api_re_melange_js-bigint.md\":\"XGTHKROM\",\"api_re_melange_belt-map-int.md\":\"5-Lt5qEP\",\"api_re_melange_belt-sortarray-string.md\":\"W5eO3naj\",\"api_re_melange_belt-range.md\":\"QC0TNrqm\",\"api_re_melange_belt-id-makecomparableu-argument-1-m.md\":\"2L4BlqtP\",\"api_re_melange_belt.md\":\"1tzNKb9o\",\"api_re_melange_belt-id-makecomparable-argument-1-m.md\":\"6lwkUUom\",\"api_re_melange_belt-set.md\":\"uyPXUHrc\",\"api_re_melange_js-promise.md\":\"Xfrg2v_Q\",\"api_ml_melange_belt-float.md\":\"sc87GiQX\",\"api_re_melange_belt-mutableset-string.md\":\"8kF9KFzy\",\"api_re_melange_belt-mutablemap-string.md\":\"NTLF263i\",\"api_re_melange_belt-mutablemap.md\":\"wbvcxt3f\",\"api_re_melange_belt-id-module-type-comparable.md\":\"mT3J1dwN\",\"api_ml_melange_stdlib-filename.md\":\"6aEASMmb\",\"api_ml_melange_stdlib-scanf-scanning.md\":\"gT6XTX8F\",\"api_ml_melange_stdlib-weak.md\":\"pYTKkSnM\",\"api_re_melange_belt-mutableset.md\":\"2CStyO-o\",\"api_re_melange_js-set.md\":\"tYhETPDE\",\"api_ml_melange_stdlib-morelabels-hashtbl-makeseeded-argument-1-h.md\":\"YP1nr9GJ\",\"api_re_melange_belt-set-int.md\":\"IUZB3aFM\",\"api_ml_melange_stdlib-morelabels-set.md\":\"jl-5sq4c\",\"api_ml_melange_stdlib-random.md\":\"9DInHjJ3\",\"api_re_melange_js-obj.md\":\"FnlurAcR\",\"api_re_melange_belt-id-makecomparableu.md\":\"cogbxObm\",\"api_re_melange_belt-hashset-string.md\":\"E011uyi1\",\"api_re_melange_belt-mutablestack.md\":\"taJUKb-F\",\"api_ml_melange_stdlib-unit.md\":\"NQC24PIo\",\"api_re_melange_js-json.md\":\"-v_e59qb\",\"api_re_melange_belt-mutableset-int.md\":\"Bx-B4jSM\",\"api_re_melange_belt-hashset-int.md\":\"BJUWAveM\",\"api_ml_melange_stdlib-uchar.md\":\"NHQg6vlv\",\"api_ml_melange_index.md\":\"b_1ebmP6\",\"api_re_melange_js-int.md\":\"H4qZ_prh\",\"api_ml_melange_stdlib-sys-immediate64-make-argument-2-non_immediate.md\":\"BNkCKroY\",\"api_re_melange_dom-storage.md\":\"ZKTxQbKM\",\"api_re_melange_belt-map-string.md\":\"zsfhC4yC\",\"api_ml_melange_stdlib-digest-blake256.md\":\"lqvZMKNd\",\"api_re_melange_belt-map.md\":\"HmfSA0MC\",\"api_re_melange_belt-sortarray-int.md\":\"-07-8MK4\",\"api_re_melange_belt-id-makehashable-argument-1-m.md\":\"ASJNswCw\",\"api_re_melange_js-file.md\":\"qs0MHMFl\",\"api_ml_melange_stdlib-sys-immediate64-module-type-non_immediate.md\":\"WHd9PYEf\",\"api_ml_melange_stdlib-morelabels-set-module-type-orderedtype.md\":\"BHc3vQr6\",\"api_ml_melange_stdlib-morelabels-hashtbl-module-type-seededs.md\":\"1TAdlxkd\",\"api_ml_melange_stdlib-char.md\":\"rdzCId3C\",\"api_re_melange_belt-map-dict.md\":\"snIGE2kc\",\"api_ml_melange_stdlib-int.md\":\"Vb5Poykk\",\"api_ml_melange_stdlib-weak-make.md\":\"gZ3G2l0K\",\"api_ml_melange_stdlib-weak-module-type-s.md\":\"FEYbeCPM\",\"api_re_melange_belt-id-makehashable.md\":\"SaYHiuVX\",\"api_re_melange_js-exn.md\":\"XW1tsPxX\",\"api_re_melange_belt-id-makehashableu.md\":\"UGTINKRL\",\"api_ml_melange_stdlib-float-array.md\":\"KjQOyB4c\",\"api_re_melange_belt-hashset.md\":\"1kvRUHIU\",\"api_ml_melange_stdlib-hashtbl-makeseeded-argument-1-h.md\":\"B8IvBrP9\",\"api_re_melange_belt-hashmap-int.md\":\"GN3xNf_j\",\"api_ml_melange_stdlib-type.md\":\"U11GZXme\",\"api_ml_melange_stdlib-set-make-argument-1-ord.md\":\"vQQAN_4W\",\"api_ml_melange_js-typed_array-int8array.md\":\"EvOsrBZh\",\"api_ml_melange_stdlib-digest-blake512.md\":\"IN3rEMkY\",\"api_re_melange_belt-mutablequeue.md\":\"Pd_e-woy\",\"api_re_melange_belt-id-makecomparable.md\":\"CqR9kj_O\",\"api_ml_melange_stdlib-stringlabels.md\":\"VdJoOClU\",\"api_ml_melange_stdlib-weak-make-argument-1-h.md\":\"QdBgUFap\",\"api_re_melange_belt-mutablemap-int.md\":\"yRLJXTOH\",\"api_ml_melange_stdlib-sys.md\":\"R28qlW1F\",\"api_re_melange_belt-set-dict.md\":\"p2kGGspI\",\"api_re_melange_js-typed_array-float32array.md\":\"6ME1Yob9\",\"api_re_melange_belt-hashmap.md\":\"vEd51aj3\",\"api_re_melange_js-float.md\":\"LQFNbrAl\",\"api_ml_melange_stdlib-byteslabels.md\":\"bOpyUiAp\",\"api_ml_melange_stdlib-scanf.md\":\"zGjH9quE\",\"api_re_melange_js-typed_array-float64array.md\":\"gn54emNH\",\"api_re_melange_js-weakset.md\":\"_rPzZQJq\",\"api_re_melange_node-fs.md\":\"dhCkW0tA\",\"api_re_melange_js-typed_array-uint8clampedarray.md\":\"P2m3Asd_\",\"api_re_melange_stdlib-filename.md\":\"OUPmEe58\",\"api_re_melange_js-typed_array-uint8array.md\":\"W9iWc5M2\",\"api_re_melange_node-process.md\":\"6wBHfepo\",\"api_re_melange_js-typed_array-int8array.md\":\"aom4yjzX\",\"api_re_melange_stdlib-digest-blake128.md\":\"TGqx4PV2\",\"api_re_melange_stdlib-fun.md\":\"E7LD9Alk\",\"api_re_melange_stdlib-digest-blake256.md\":\"8bjatk-v\",\"api_re_melange_js.md\":\"eJyy1aRP\",\"api_re_melange_node-fs-watch.md\":\"s-Qq1OYW\",\"api_re_melange_js-typed_array.md\":\"ENpxZAvG\",\"api_re_melange_stdlib-digest-md5.md\":\"LhUy2jWn\",\"api_re_melange_node-module.md\":\"c2CyzxGH\",\"api_re_melange_js-typed_array-arraybuffer.md\":\"NDDEFg_C\",\"api_re_melange_stdlib-array.md\":\"_1V4XnAH\",\"api_re_melange_js-typed_array-dataview.md\":\"ZgtZSzda\",\"api_re_melange_stdlib-domain-dls.md\":\"vu3qSHdK\",\"api_re_melange_stdlib-hashtbl-make-argument-1-h.md\":\"vpUKJ5Hj\",\"api_re_melange_stdlib-digest-module-type-s.md\":\"y-TjHDg5\",\"api_re_melange_stdlib-hashtbl-makeseeded-argument-1-h.md\":\"pJ4gX0Cs\",\"api_re_melange_js-weakmap.md\":\"2rec_AiV\",\"api_re_melange_stdlib-arraylabels.md\":\"NQbA56RC\",\"api_re_melange_stdlib-map-make-argument-1-ord.md\":\"sFvqyb3T\",\"api_re_melange_stdlib-byteslabels.md\":\"s0ZCrYxk\",\"api_re_melange_node.md\":\"c-IWGtIk\",\"community.md\":\"bMSUbF9G\",\"api_re_melange_stdlib-int.md\":\"Eicf34TT\",\"api_re_melange_belt-array.md\":\"GeVgVFBn\",\"api_re_melange_belt-list.md\":\"I4FEJsWr\",\"api_re_melange_js-string.md\":\"41vGTNwt\",\"api_re_melange_stdlib-buffer.md\":\"Gw7NGV1Z\",\"api_re_melange_stdlib-domain.md\":\"Kk0azv9p\",\"api_re_melange_stdlib-gc-memprof.md\":\"WPAER6xp\",\"api_re_melange_stdlib-set-module-type-orderedtype.md\":\"v3T0omH2\",\"api_re_melange_stdlib-set.md\":\"eEiZEUkH\",\"api_re_melange_js-typed_array-uint32array.md\":\"NmLPKsly\",\"api_re_melange_js-typed_array-int16array.md\":\"FnF4cBRU\",\"api_re_melange_node-buffer.md\":\"6VEnJl3v\",\"api_re_melange_stdlib-either.md\":\"O0-QoYb6\",\"api_re_melange_stdlib-arg.md\":\"Un0OmxaI\",\"api_re_melange_stdlib-printexc.md\":\"5le-jcLg\",\"api_re_melange_stdlib-gc.md\":\"kq80GLhc\",\"api_re_melange_stdlib-float.md\":\"LajE2tTw\",\"api_re_melange_stdlib-map-make.md\":\"N29zyYsN\",\"api_re_melange_stdlib-map-module-type-orderedtype.md\":\"2WPCk1Az\",\"api_re_melange_stdlib-morelabels-map-module-type-orderedtype.md\":\"cB2PDU4U\",\"api_re_melange_stdlib-set-make-argument-1-ord.md\":\"Qkph2CXw\",\"api_re_melange_stdlib-morelabels-set-make-argument-1-ord.md\":\"uV7LgcoS\",\"api_re_melange_stdlib-hashtbl-module-type-hashedtype.md\":\"63n78AlF\",\"api_re_melange_stdlib-sys-immediate64-make-argument-2-non_immediate.md\":\"wpOsGW5S\",\"api_re_melange_stdlib-morelabels-map-make.md\":\"gcxvT97t\",\"api_re_melange_stdlib-morelabels-map-make-argument-1-ord.md\":\"JXa_EW0a\",\"communicate-with-javascript.md\":\"71kLkG5N\",\"api_re_melange_stdlib-int64.md\":\"sA42bzD8\",\"api_re_melange_stdlib-weak.md\":\"j9t4lRKk\",\"api_re_melange_stdlib-largefile.md\":\"x4jm26AT\",\"api_re_melange_stdlib-random-state.md\":\"JM-l5oHV\",\"api_re_melange_stdlib-hashtbl-module-type-s.md\":\"VPKSeDoi\",\"api_re_melange_node-path.md\":\"KDIR1neP\",\"api_re_melange_stdlib-mutex.md\":\"CiRyg9Xw\",\"api_re_melange_stdlib-sys-immediate64-make.md\":\"Wc18NPir\",\"api_re_melange_stdlib-lazy.md\":\"2OFZfvgd\",\"api_re_melange_stdlib-sys-immediate64-module-type-non_immediate.md\":\"unKEYPes\",\"api_re_melange_stdlib-sys-immediate64.md\":\"7AuJW_kL\",\"api_re_melange_stdlib-type.md\":\"6po1tMRC\",\"api_re_melange_stdlib-int32.md\":\"LoDIhBSd\",\"api_re_melange_stdlib-in_channel.md\":\"28sERQ3q\",\"api_re_melange_stdlib-morelabels-set-make.md\":\"ydsShhHF\",\"api_re_melange_stdlib-unit.md\":\"eLwhwppR\",\"api_re_melange_stdlib-morelabels-hashtbl.md\":\"YZ8ob351\",\"blog_posts_the-rest-of-2023-in-melange.md\":\"AkGTpnXV\",\"api_re_melange_stdlib-morelabels-hashtbl-module-type-seededhashedtype.md\":\"qPXd7B2Q\",\"api_re_melange_stdlib-morelabels-hashtbl-module-type-seededs.md\":\"eAQLXR_Z\",\"api_re_melange_stdlib-queue.md\":\"-CJ4Q75c\",\"api_re_melange_stdlib-bytes.md\":\"ij6tnLLE\",\"api_re_melange_stdlib-morelabels-set-module-type-s.md\":\"SJbTmzog\",\"api_re_melange_stdlib-parsing.md\":\"zjkZ_SBG\",\"blog_posts_whats-next-for-melange.md\":\"pA45j0TB\",\"api_re_melange_stdlib-stringlabels.md\":\"uoxY5JQ0\",\"api_re_melange_stdlib-hashtbl-module-type-seededhashedtype.md\":\"ykhSmi75\",\"api_re_melange_stdlib-stack.md\":\"KJe-DUJ0\",\"api_re_melange_stdlib-scanf.md\":\"ex4T0qFh\",\"api_re_melange_stdlib-random.md\":\"QwIWex-H\",\"api_re_melange_stdlib-weak-make.md\":\"cnG58bUF\",\"api_re_melange_stdlib-morelabels-hashtbl-module-type-hashedtype.md\":\"Ck0pWNZH\",\"api_re_melange_stdlib-sys.md\":\"sKUwihDN\",\"api_re_melange_stdlib-morelabels-hashtbl-make.md\":\"BUTfKGJZ\",\"blog_posts_dune-universal-libraries-preview.md\":\"R7IzP2f8\",\"api_re_melange_stdlib-hashtbl-makeseeded.md\":\"jFk1asHL\",\"new-to-ocaml.md\":\"PhdDgQyW\",\"api_re_melange_stdlib-map-module-type-s.md\":\"qH2dAmMn\",\"build-system.md\":\"_f3zPHTn\",\"api_re_melange_stdlib-map.md\":\"uiQbwAAB\",\"api_re_melange_stdlib-marshal.md\":\"0C5fI8Cs\",\"api_re_melange_stdlib-bool.md\":\"UyMhpBAO\",\"api_re_melange_stdlib-digest-blake512.md\":\"3Jkuve7J\",\"api_re_melange_stdlib-morelabels-hashtbl-make-argument-1-h.md\":\"8Y8pMUxA\",\"blog_posts_melange-4-is-here.md\":\"g6ncEFTY\",\"blog_posts_introducing-melange-20.md\":\"YAACfU-V\",\"attributes-and-extension-nodes.md\":\"9aC9Eu5H\",\"api_re_melange_stdlib-digest.md\":\"vJ9qPpM0\",\"blog_posts_whats-2024-brought-to-melange-so-far.md\":\"wxnDI1JR\",\"api_re_melange_stdlib-sys-immediate64-module-type-immediate.md\":\"JEHamfpc\",\"api_re_melange_stdlib-obj.md\":\"7kwi78Ab\",\"api_re_melange_stdlib-seq.md\":\"7p3cLGvb\",\"api_re_melange_stdlib-dynarray.md\":\"_FHpo61k\",\"getting-started.md\":\"I4ae7Tn7\",\"index.md\":\"4spaZXZH\",\"api_re_melange_stdlib-obj-ephemeron.md\":\"_BzN9xIV\",\"api_re_melange_stdlib-morelabels-map.md\":\"FBXJ0tXE\",\"api_re_melange_stdlib-option.md\":\"W3DYABj-\",\"api_re_melange_stdlib-sys-immediate64-make-argument-1-immediate.md\":\"YSC8OOPU\",\"blog_posts_announcing-melange-3.md\":\"f8fJHCGi\",\"blog_posts_announcing-melange-5.md\":\"cWrVKXCZ\",\"api_re_melange_stdlib-format.md\":\"V0GU1TUl\",\"api_re_melange_stdlib-lexing.md\":\"E5ou4aoq\",\"api_re_melange_stdlib-string.md\":\"rE8nMNAm\",\"api_re_melange_stdlib-oo.md\":\"z-0B-zFV\",\"api_re_melange_stdlib-morelabels-set.md\":\"zt3Q6e0s\",\"api_re_melange_stdlib-complex.md\":\"S_ctHGIr\",\"api_re_melange_stdlib-type-id.md\":\"3j2J3Piu\",\"api_re_melange_stdlib-out_channel.md\":\"MORfWBf2\",\"api_re_melange_stdlib-morelabels-hashtbl-makeseeded-argument-1-h.md\":\"0ZIXuc0g\",\"api_re_melange_index.md\":\"upHYfs5D\",\"blog_index.md\":\"kFAfh-UM\",\"data-types-and-runtime-rep.md\":\"2ZnsxAsc\",\"api_re_melange_stdlib.md\":\"LW81KDnh\",\"api_re_melange_stdlib-obj-extension_constructor.md\":\"UVrN8sHJ\",\"api_re_melange_js-types.md\":\"vXtMjPhQ\",\"api_re_melange_stdlib-weak-make-argument-1-h.md\":\"oTzed-zl\",\"api_re_melange_stdlib-atomic.md\":\"xuYgt_9W\",\"api_re_melange_stdlib-weak-module-type-s.md\":\"V2UNDE8W\",\"api_re_melange_stdlib-morelabels-map-module-type-s.md\":\"5_PE8byd\",\"api_re_melange_stdlib-stdlabels.md\":\"7x2OMOPH\",\"api_re_melange_stdlib-set-make.md\":\"B4RfhkD-\",\"api_re_melange_stdlib-char.md\":\"UOpNStUa\",\"api_re_melange_stdlib-set-module-type-s.md\":\"oPnlqonf\",\"api_re_melange_stdlib-uchar.md\":\"L7DEdjcr\",\"api_re_melange_node-child_process.md\":\"5tj3af4z\",\"resources.md\":\"qm8ckyWX\",\"api_re_melange_dom.md\":\"chhWMY3t\",\"api_re_melange_js-typed_array-uint16array.md\":\"GbVJO2ap\",\"roadmap.md\":\"JXjFaaKh\",\"api_re_melange_stdlib-morelabels-hashtbl-makeseeded.md\":\"-W5J7Nyr\",\"api_re_melange_stdlib-float-array.md\":\"vK7VUCrU\",\"api_re_melange_stdlib-hashtbl.md\":\"Z7mPBoP0\",\"api_re_melange_stdlib-morelabels.md\":\"Gh5p0SER\",\"api_re_melange_stdlib-hashtbl-make.md\":\"HDFMaoXA\",\"api_re_melange_stdlib-morelabels-set-module-type-orderedtype.md\":\"6qIVpBcZ\",\"api_re_melange_stdlib-printexc-slot.md\":\"C_PKKb_-\",\"what-is-melange.md\":\"x05Om_MI\",\"api_re_melange_stdlib-printf.md\":\"Py05DmbN\",\"api_re_melange_stdlib-morelabels-hashtbl-module-type-s.md\":\"MioloI-d\",\"language-concepts.md\":\"tINY0dOV\",\"how-to-guides.md\":\"XnLXEVmu\",\"melange-for-x-developers.md\":\"ufqZrSvU\",\"api_re_melange_js-typed_array-int32array.md\":\"jkLAzgmT\",\"api_re_melange_stdlib-list.md\":\"fwrN9PMW\",\"api_re_melange_stdlib-listlabels.md\":\"7eyagArQ\",\"api_re_melange_stdlib-scanf-scanning.md\":\"75NnAH64\",\"api_re_melange_stdlib-result.md\":\"3V7Q_Jsp\",\"package-management.md\":\"JpapE47N\",\"syntaxes.md\":\"jKGcKuzx\",\"rationale.md\":\"Pfxlf9Gw\",\"api_re_melange_stdlib-hashtbl-module-type-seededs.md\":\"Nj44SC-I\",\"bindings-cookbook.md\":\"IOB5fGGs\",\"working-with-js-objects-and-values.md\":\"Pm0FY7X8\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Melange\",\"description\":\"The official documentation site for Melange, a compiler from OCaml to JavaScript. Explore the features and resources for functional programming with Melange, including the standard libraries APIs, the playground, and extensive documentation about bindings, build system, and the opam package manager.\",\"base\":\"/unstable/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"outline\":{\"level\":[2,3]},\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/melange-re/melange-re.github.io/edit/master/docs/:path\"},\"nav\":[{\"text\":\"Learn\",\"link\":\"/what-is-melange\"},{\"text\":\"API\",\"link\":\"/api\"},{\"text\":\"Playground\",\"link\":\"/playground/\",\"target\":\"_self\"},{\"text\":\"Book\",\"link\":\"https://react-book.melange.re\"},{\"text\":\"Blog\",\"link\":\"https://melange.re/blog/\"},{\"text\":\"unstable\",\"items\":[{\"text\":\"v4.0.0\",\"link\":\"https://melange.re/v4.0.0/\"},{\"text\":\"v3.0.0\",\"link\":\"https://melange.re/v3.0.0/\"},{\"text\":\"v2.2.0\",\"link\":\"https://melange.re/v2.2.0/\"},{\"text\":\"v2.1.0\",\"link\":\"https://melange.re/v2.1.0/\"},{\"text\":\"v2.0.0\",\"link\":\"https://melange.re/v2.0.0/\"},{\"text\":\"v1.0.0\",\"link\":\"https://melange.re/v1.0.0/\"}]}],\"sidebar\":{\"/blog/\":[],\"/\":[{\"text\":\"Intro\",\"items\":[{\"text\":\"What is Melange\",\"link\":\"/what-is-melange\"},{\"text\":\"Rationale\",\"link\":\"/rationale\"},{\"text\":\"Supported syntaxes\",\"link\":\"/syntaxes\"},{\"text\":\"Getting Started\",\"link\":\"/getting-started\"}]},{\"text\":\"Learn\",\"items\":[{\"text\":\"New to OCaml?\",\"link\":\"/new-to-ocaml\"},{\"text\":\"Package Management\",\"link\":\"/package-management\"},{\"text\":\"Build System\",\"link\":\"/build-system\"},{\"text\":\"How-to Guides\",\"link\":\"/how-to-guides\"},{\"text\":\"Melange for X Developers\",\"link\":\"/melange-for-x-developers\"}]},{\"text\":\"Communicate with JavaScript\",\"items\":[{\"text\":\"Overview\",\"link\":\"/communicate-with-javascript\"},{\"text\":\"Language concepts\",\"link\":\"/language-concepts\"},{\"text\":\"Data types and runtime representation\",\"link\":\"/data-types-and-runtime-rep\"},{\"text\":\"Melange attributes and extension nodes\",\"link\":\"/attributes-and-extension-nodes\"},{\"text\":\"Working with JavaScript objects and values\",\"link\":\"/working-with-js-objects-and-values\"},{\"text\":\"Advanced JavaScript interoperability\",\"link\":\"/advanced-js-interop\"},{\"text\":\"Bindings cookbook\",\"link\":\"/bindings-cookbook\"}]},{\"text\":\"Reference\",\"items\":[{\"text\":\"API\",\"link\":\"/api\"}]},{\"text\":\"Try\",\"items\":[{\"text\":\"Playground\",\"link\":\"/playground/\",\"target\":\"_self\"}]},{\"text\":\"About\",\"items\":[{\"text\":\"Community\",\"link\":\"/community\"},{\"text\":\"Resources\",\"link\":\"/resources\"},{\"text\":\"Roadmap\",\"link\":\"/roadmap\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/melange-re/melange\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>