<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Melange 4.0 is here | Sandtracks</title>
    <meta name="description" content="The official blog for the Melange project">
    <meta name="generator" content="VitePress v1.0.0-rc.42">
    <link rel="preload stylesheet" href="/blog/assets/style.EfEfGRmq.css" as="style">
    
    <script type="module" src="/blog/assets/app.Fjwmjcop.js"></script>
    <link rel="modulepreload" href="/blog/assets/chunks/framework.esbpoalq.js">
    <link rel="modulepreload" href="/blog/assets/chunks/theme.e5RzdRmk.js">
    <link rel="modulepreload" href="/blog/assets/posts_melange-4-is-here.md.PMYZfQpm.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="antialiased dark:bg-zinc-900"><div class="max-w-3xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><nav class="flex justify-between items-center py-10 font-bold"><a class="text-xl" href="/blog/" aria-label="Sandtracks"><span class="hidden md:inline dark:text-white">Sandtracks</span></a><div class="text-sm text-gray-500 dark:text-white leading-5"><a class="hover:text-gray-700 dark:hover:text-gray-200" href="https://github.com/melange-re/melange-re.github.io/" target="_blank" rel="noopener"><span class="hidden sm:inline">GitHub </span>Source</a><span class="mr-2 ml-2">·</span><a class="hover:text-gray-700 dark:hover:text-gray-200" href="/blog/feed.rss" target="_self">RSS<span class="hidden sm:inline"> Feed</span></a><span class="mr-2 ml-2">·</span><a class="hover:text-gray-700 dark:hover:text-gray-200" href="https://melange.re" target="_blank" rel="noopener">melange.re →</a></div></nav></div><main class="max-w-3xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><article class="xl:divide-y xl:divide-gray-200 dark:xl:divide-slate-200/5"><header class="pt-6 xl:pb-10 space-y-1 text-center"><dl><dt class="sr-only">Published on</dt><dd class="text-base leading-6 font-medium text-gray-500 dark:text-gray-300"><time datetime="2024-05-22T12:00:00.000Z">May 22, 2024</time></dd></dl><h1 class="text-3xl leading-9 font-extrabold text-gray-900 dark:text-white tracking-tight sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Melange 4.0 is here</h1></header><div class="divide-y xl:divide-y-0 divide-gray-200 dark:divide-slate-200/5 xl:grid xl:grid-cols-4 xl:gap-x-10 pb-16 xl:pb-20" style="grid-template-rows:auto 1fr;"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 dark:xl:border-slate-200/5"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center xl:block space-x-8 sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><img src="https://gravatar.com/avatar/45c2052f50f561b9dc2cae59c777aecd794f57269fa317f9c9c3365c2e00d16f" alt="author image" class="w-10 h-10 rounded-full"><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-white">Antonio Monteiro</dd><dt class="sr-only">Twitter</dt><dd><a href="https://twitter.com/@_anmonteiro" target="_blank" rel="noopnener noreferrer" class="link">@_anmonteiro</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-slate-200/5 xl:pb-0 xl:col-span-3 xl:row-span-2"><div style="position:relative;" class="prose dark:prose-invert max-w-none pt-10 pb-8"><div><p>Today, we&#39;re introducing Melange 4.0, the latest version of our backend for the OCaml compiler that emits JavaScript.</p><p>Melange is now compatible with OCaml 5.2! In this release, Melange starts emitting more ES6 constructs, supports more JavaScript builtins, improves error handling, and makes using Dune virtual libraries fully supported. Read on for more details.</p><hr><h2 id="embracing-ocaml-5-2" tabindex="-1">Embracing OCaml 5.2 <a class="header-anchor" href="#embracing-ocaml-5-2" aria-label="Permalink to &quot;Embracing OCaml 5.2&quot;">​</a></h2><p>OCaml 5.2 was released just last week. With Melange 4, you can now leverage all the power and enhancements in this latest OCaml version. We&#39;ve upgraded the OCaml type checker and the standard library to match OCaml 5.2&#39;s, ensuring you can select a 5.2-compatible Melange in your projects.</p><p>This does <strong>not</strong> mean Melange is only compatible with OCaml 5.2. As previously mentioned in the <a href="./announcing-melange-3#multiple-ocaml-version-releases">Melange 3 announcement</a>, each Melange version ships one release for every compiler version that it supports; for OCaml 5.1, this would correspond to Melange <code>4.0.0-51</code>.</p><h2 id="full-support-for-dune-virtual-libraries" tabindex="-1">Full Support for Dune Virtual Libraries <a class="header-anchor" href="#full-support-for-dune-virtual-libraries" aria-label="Permalink to &quot;Full Support for Dune Virtual Libraries&quot;">​</a></h2><p>Melange now fully supports <a href="https://dune.readthedocs.io/en/stable/variants.html" target="_blank" rel="noreferrer">Dune virtual libraries</a>, which requires Dune 3.15.2. There were a few bumps in road when we thought it wouldn&#39;t be possible to support this use case in Melange. We were thankfully proven wrong (<a href="https://github.com/melange-re/melange/pull/1067" target="_blank" rel="noreferrer">#1067</a>), and we think that virtual libraries can become an interesting way to write libraries that work across Melange and native OCaml, sharing a common interface.</p><h2 id="emitting-es6-and-enhanced-javascript-interop" tabindex="-1">Emitting ES6 and Enhanced JavaScript Interop <a class="header-anchor" href="#emitting-es6-and-enhanced-javascript-interop" aria-label="Permalink to &quot;Emitting ES6 and Enhanced JavaScript Interop&quot;">​</a></h2><p>In this release, Melange starts emitting ES6, particularly:</p><ul><li>Melange 4.0 emits <code>let</code> instead of <code>var</code>, and <code>const</code> where possible (<a href="https://github.com/melange-re/melange/pull/1019" target="_blank" rel="noreferrer">#1019</a>, <a href="https://github.com/melange-re/melange/pull/1059" target="_blank" rel="noreferrer">#1059</a>).</li><li>Emitting <code>let</code> allowed us to remove a bit of legacy code related to compiling <code>for</code> loops, taking advantage of <code>let</code>&#39;s lexical scoping. (<a href="https://github.com/melange-re/melange/pull/1020" target="_blank" rel="noreferrer">#1020</a>)</li></ul><p>In our effort to expand the API surface area for JavaScript interoperability, we&#39;ve added new bindings to a few more JavaScript features in the <code>melange.js</code> library (whose main entrypoint is the <code>Js</code> module):</p><ul><li><strong>Js.Bigint</strong>: <a href="https://github.com/melange-re/melange/pull/1044" target="_blank" rel="noreferrer">#1044</a> added bindings to work with <code>BigInt</code>;</li><li>The <strong>Js.Set</strong> and <strong>Js.Map</strong> modules now bind to even more methods available in these JavaScript data structures (<a href="https://github.com/melange-re/melange/pull/1047" target="_blank" rel="noreferrer">#1047</a>, <a href="https://github.com/melange-re/melange/pull/1101" target="_blank" rel="noreferrer">#1101</a>).</li><li><strong>JS Iterators</strong>: We introduced minimal bindings for JavaScript iterators, making it easier to work with iterable objects, which some other modules&#39; methods can now return (<a href="https://github.com/melange-re/melange/pull/1060" target="_blank" rel="noreferrer">#1060</a>).</li><li><strong>WeakMap and WeakSet</strong>: Bindings for these weakly referenced collections have also been added (<a href="https://github.com/melange-re/melange/pull/1058" target="_blank" rel="noreferrer">#1058</a>).</li></ul><h2 id="improved-error-handling-and-code-generation" tabindex="-1">Improved Error Handling and Code Generation <a class="header-anchor" href="#improved-error-handling-and-code-generation" aria-label="Permalink to &quot;Improved Error Handling and Code Generation&quot;">​</a></h2><p>In this release, we&#39;ve also made significant improvements in how Melange handles errors and generates JavaScript code:</p><ul><li>Instead of throwing JavaScript objects with Melange exception payloads, we now emit a Melange-specific error (<code>throw new MelangeError(..)</code>) for more consistent error handling (<a href="https://github.com/melange-re/melange/pull/1036" target="_blank" rel="noreferrer">#1036</a>). <ul><li>An interesting corollary to this change is that catching Melange errors from external JavaScript only needs to check <code>instanceof MelangeError</code>.</li></ul></li></ul><h2 id="additional-fixes-enhancements" tabindex="-1">Additional Fixes &amp; Enhancements <a class="header-anchor" href="#additional-fixes-enhancements" aria-label="Permalink to &quot;Additional Fixes &amp; Enhancements&quot;">​</a></h2><ul><li><strong>Slimmer Executable</strong>: We&#39;ve removed unnecessary internal code from <code>melange-compiler-libs</code>, making the Melange compiled executable smaller in size and faster to build (<a href="https://github.com/melange-re/melange/pull/1075" target="_blank" rel="noreferrer">#1075</a>).</li><li><strong>Float Operations</strong>: Fixed runtime primitives for <code>Float.{min,max}</code> and related functions, ensuring more accurate mathematical operations (<a href="https://github.com/melange-re/melange/pull/1050" target="_blank" rel="noreferrer">#1050</a>).</li><li><strong>Warning 51 (<code>wrong-tailcall-expectation</code>)</strong>: Melange 4 ships with support for enabling warning 51 and triggering the warning when <a href="https://ocaml.org/manual/5.2/attributes.html#ss:builtin-attributes" target="_blank" rel="noreferrer"><code>[@tailcall]</code></a> is used (<a href="https://github.com/melange-re/melange/pull/1075" target="_blank" rel="noreferrer">#1075</a>).</li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>The <a href="https://github.com/melange-re/melange/blob/main/Changes.md#400-2024-05-15" target="_blank" rel="noreferrer">Melange 4.0 changelog</a> lists all the changes that made it to this release.</p><p>Thanks for reading and stay tuned for more updates. Happy hacking!</p></div></div></div><footer class="text-sm font-medium leading-5 divide-y divide-gray-200 dark:divide-slate-200/5 xl:col-start-1 xl:row-start-2"><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Next Article </h2><div class="link"><a href="/blog/posts/announcing-melange-5">Announcing Melange 5</a></div></div><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Previous Article </h2><div class="link"><a href="/blog/posts/dune-universal-libraries-preview">A Preview of Universal Libraries in Dune</a></div></div><div class="pt-8"><a class="link" href="/blog">← Back to the blog</a></div></footer></div></article></main></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"posts_dune-universal-libraries-preview.md\":\"Xa7i7d6o\",\"index.md\":\"taMKmGVM\",\"posts_introducing-melange-20.md\":\"BABT5VNk\",\"posts_whats-next-for-melange.md\":\"cWDv6M5T\",\"posts_whats-2024-brought-to-melange-so-far.md\":\"LEr3Iv7R\",\"posts_the-rest-of-2023-in-melange.md\":\"vftBUth_\",\"posts_melange-4-is-here.md\":\"PMYZfQpm\",\"posts_announcing-melange-3.md\":\"b71y2TT7\",\"posts_announcing-melange-5.md\":\"LwaIObJD\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Sandtracks\",\"description\":\"The official blog for the Melange project\",\"base\":\"/blog/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>